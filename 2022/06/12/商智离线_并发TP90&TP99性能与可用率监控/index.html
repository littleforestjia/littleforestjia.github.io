<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="线程池," />










<meta name="description" content="商智离线_并发TP90&amp;TP99性能与可用率监控1.监控原理1.1基本概念方法性能就是指方法的调用时间，主要用TP50、TP90、TP99等(top percent)表示。 TP90就是在监控单位时间内的所有调用中，90%调用完成所需要的最短时间。统计1分钟内的所有调用所需时间，从小到大排序，前90%中的最后一个即为1分钟内的TP90。 方法可用率是指方法调用成功率，不发生异常的概率。 1">
<meta property="og:type" content="article">
<meta property="og:title" content="商智离线_并发TP90&amp;TP99性能与可用率监控">
<meta property="og:url" content="http://https//littleforestjia.github.io/2022/06/12/%E5%95%86%E6%99%BA%E7%A6%BB%E7%BA%BF_%E5%B9%B6%E5%8F%91TP90&TP99%E6%80%A7%E8%83%BD%E4%B8%8E%E5%8F%AF%E7%94%A8%E7%8E%87%E7%9B%91%E6%8E%A7/index.html">
<meta property="og:site_name" content="岩手县小森的博客">
<meta property="og:description" content="商智离线_并发TP90&amp;TP99性能与可用率监控1.监控原理1.1基本概念方法性能就是指方法的调用时间，主要用TP50、TP90、TP99等(top percent)表示。 TP90就是在监控单位时间内的所有调用中，90%调用完成所需要的最短时间。统计1分钟内的所有调用所需时间，从小到大排序，前90%中的最后一个即为1分钟内的TP90。 方法可用率是指方法调用成功率，不发生异常的概率。 1">
<meta property="article:published_time" content="2022-06-11T16:00:00.000Z">
<meta property="article:modified_time" content="2022-06-12T14:39:59.741Z">
<meta property="article:author" content="zju岩手县小森">
<meta property="article:tag" content="线程池">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://https://littleforestjia.github.io/2022/06/12/商智离线_并发TP90&TP99性能与可用率监控/"/>





  <title>商智离线_并发TP90&TP99性能与可用率监控 | 岩手县小森的博客</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">岩手县小森的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力将眼前的每一天过得精彩</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://https://littleforestjia.github.io/2022/06/12/%E5%95%86%E6%99%BA%E7%A6%BB%E7%BA%BF_%E5%B9%B6%E5%8F%91TP90&TP99%E6%80%A7%E8%83%BD%E4%B8%8E%E5%8F%AF%E7%94%A8%E7%8E%87%E7%9B%91%E6%8E%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zju岩手县小森">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岩手县小森的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">商智离线_并发TP90&TP99性能与可用率监控</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-06-12T00:00:00+08:00">
                2022-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%95%86%E6%99%BA%E7%A6%BB%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">商智离线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="商智离线-并发TP90-amp-TP99性能与可用率监控"><a href="#商智离线-并发TP90-amp-TP99性能与可用率监控" class="headerlink" title="商智离线_并发TP90&amp;TP99性能与可用率监控"></a>商智离线_并发TP90&amp;TP99性能与可用率监控</h2><h3 id="1-监控原理"><a href="#1-监控原理" class="headerlink" title="1.监控原理"></a>1.监控原理</h3><h4 id="1-1基本概念"><a href="#1-1基本概念" class="headerlink" title="1.1基本概念"></a>1.1基本概念</h4><p><strong>方法性能就是指方法的调用时间</strong>，主要用TP50、TP90、TP99等(top percent)表示。</p>
<p>TP90就是在监控单位时间内的所有调用中，90%调用完成所需要的最短时间。统计1分钟内的所有调用所需时间，从小到大排序，前90%中的最后一个即为1分钟内的TP90。</p>
<p><strong>方法可用率是指方法调用成功率，不发生异常的概率</strong>。</p>
<h4 id="1-2实现思路"><a href="#1-2实现思路" class="headerlink" title="1.2实现思路"></a>1.2实现思路</h4><p>监控某个方法的调用时间和可用率基本步骤：</p>
<ul>
<li>方法开始前开始记时；</li>
<li>方法发生异常时记录失败；</li>
<li>方法完成时记录总时间。</li>
</ul>
<p>单机部署应用的监控数据，可以保存在本地内存中的static变量、缓存，也可以保存在本地硬盘中的数据库、日志文件等。</p>
<p><strong>如果要看分布式部署应用总的监控，则必须远程保存到同一个地方，缓存、日志文件、db都可以实现。</strong></p>
<h3 id="2-单机实例"><a href="#2-单机实例" class="headerlink" title="2.单机实例"></a>2.单机实例</h3><h4 id="2-1监控方法类"><a href="#2-1监控方法类" class="headerlink" title="2.1监控方法类"></a>2.1监控方法类</h4><p>核心属性与方法：</p>
<ul>
<li>两个<code>Map&lt;String, DelayQueue&lt;T&gt;&gt;</code>类型属性用于分别保存调用时间和调用异常数据；</li>
<li>static代码块执行定时删除过期数据逻辑；</li>
<li>start()用于起使位置埋点，error()用于异常位置埋点，end()用于结束位置埋点，getAP()用于获取方法可用率数据，getTP()用于获取方法性能数据。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jia.zheng.monitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Monitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重要：此处最好不要用LinkedList来保存服务调用时间队列，因为LinkedList只能通过index倒序删除数据，存在线程安全问题，在删除数据同时插入数据，导致删错数据。</span></span><br><span class="line">    <span class="comment">//costTime中key为服务方法名，DelayQueue&lt;CostTime&gt;中保存了方法调用时间队列；</span></span><br><span class="line">    <span class="comment">//errorCount中key为服务方法名，一旦方法异常，则向DelayQueue&lt;ErrorCount&gt;中插入一个ErrorCount对象，直接用Queue的长度来进行调用失败计数。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, DelayQueue&lt;CostTime&gt;&gt; costTime = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, DelayQueue&lt;ErrorCount&gt;&gt; errorCount = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个定时轮询线程池，用来定时执行过期的数据删除。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        scheduledThreadPool.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, DelayQueue&lt;CostTime&gt;&gt; entry : costTime.entrySet()) &#123;</span><br><span class="line">                    <span class="comment">//重要：将队列中过期时间小于或等于0的CostTime全都删除。DelayQueue、Delayed、Predicate这一套东西也很有意思。</span></span><br><span class="line">                    entry.getValue().removeIf(<span class="keyword">new</span> Predicate&lt;CostTime&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(CostTime costTime)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> costTime.getDelay(TimeUnit.MILLISECONDS) &lt;= <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, DelayQueue&lt;ErrorCount&gt;&gt; entry : errorCount.entrySet()) &#123;</span><br><span class="line">                    entry.getValue().removeIf(<span class="keyword">new</span> Predicate&lt;ErrorCount&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(ErrorCount errorCount)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> errorCount.getDelay(TimeUnit.MILLISECONDS) &lt;= <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">5</span>, TimeUnit.SECONDS);<span class="comment">//项目启动时就开始运行，每5s执行一次。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Info <span class="title">start</span><span class="params">(String serviceName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Info(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Info info)</span> </span>&#123;</span><br><span class="line">        info.setState(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(Info info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (info.isState()) &#123;<span class="comment">//服务调用正常</span></span><br><span class="line">            DelayQueue&lt;CostTime&gt; delayQueue = costTime.get(info.getServiceName());</span><br><span class="line">            <span class="keyword">if</span> (delayQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                delayQueue = <span class="keyword">new</span> DelayQueue&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//重要：设置数据的过期时间，此处设置CostTime对象的过期时间为60s，也就是说计算方法性能和可用率的单位时间为60s。</span></span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> CostTime(System.currentTimeMillis() - info.getStartTime(), <span class="number">60</span> * <span class="number">1000</span>));</span><br><span class="line">            costTime.put(info.getServiceName(), delayQueue);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;<span class="comment">//服务调用发生错误</span></span><br><span class="line">            DelayQueue&lt;ErrorCount&gt; delayQueue = errorCount.get(info.getServiceName());</span><br><span class="line">            <span class="keyword">if</span> (delayQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                delayQueue = <span class="keyword">new</span> DelayQueue&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> ErrorCount(<span class="number">60</span> * <span class="number">1000</span>));</span><br><span class="line">            errorCount.put(info.getServiceName(), delayQueue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算服务失败数和成功数，用于计算可用率，就是 (1-失败数/(失败数+时间数））</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] getAP(String serviceName) &#123;</span><br><span class="line">        <span class="keyword">int</span>[] AP = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        AP[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        AP[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        DelayQueue&lt;CostTime&gt; costQueue = costTime.get(serviceName);</span><br><span class="line">        DelayQueue&lt;ErrorCount&gt; errorQueue = errorCount.get(serviceName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (errorQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (costQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> AP;</span><br><span class="line">            &#125;</span><br><span class="line">            AP[<span class="number">1</span>] = costQueue.size();</span><br><span class="line">            <span class="keyword">return</span> AP;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AP[<span class="number">0</span>] = errorQueue.size();</span><br><span class="line">        <span class="keyword">if</span> (costQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> AP;</span><br><span class="line">        &#125;</span><br><span class="line">        AP[<span class="number">1</span>] = costQueue.size();</span><br><span class="line">        <span class="keyword">return</span> AP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算服务性能</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span>[] getTP(String serviceName) &#123;</span><br><span class="line">        <span class="keyword">long</span>[] TP = <span class="keyword">new</span> <span class="keyword">long</span>[<span class="number">2</span>];</span><br><span class="line">        TP[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">        TP[<span class="number">1</span>] = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        DelayQueue&lt;CostTime&gt; costQueue = costTime.get(serviceName);</span><br><span class="line">        <span class="keyword">if</span> (costQueue == <span class="keyword">null</span> || costQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> TP;</span><br><span class="line">        &#125;</span><br><span class="line">        CostTime[] costTimes = costQueue.toArray(<span class="keyword">new</span> CostTime[]&#123;&#125;);</span><br><span class="line">        List&lt;CostTime&gt; costTimeList = Arrays.asList(costTimes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将调用时间进行排序</span></span><br><span class="line">        Collections.sort(costTimeList, <span class="keyword">new</span> Comparator&lt;CostTime&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(CostTime o1, CostTime o2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">int</span>) (o1.getCostTime() - o2.getCostTime());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">int</span> size = costTimeList.size();</span><br><span class="line">        <span class="comment">//重要：注意要向下取整，向上取整有可能导致ArrayIndexOutOfBoundsException。</span></span><br><span class="line">        TP[<span class="number">0</span>] = costTimeList.get((<span class="keyword">int</span>) Math.floor(<span class="number">0.9</span>d * size)).getCostTime();</span><br><span class="line">        TP[<span class="number">1</span>] = costTimeList.get((<span class="keyword">int</span>) Math.floor(<span class="number">0.99</span>d * size)).getCostTime();</span><br><span class="line">        <span class="keyword">return</span> TP;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最好不要用LinkedList来保存服务调用时间队列，因为LinkedList只能通过index倒序删除数据，存在线程安全问题，在删除数据同时插入数据，导致删错数据。<strong>此处使用DelayQueue来保存相关数据，并创建定时轮询线程池，借助Delayed和Predicate定时删除过期数据。</strong></li>
<li>我们可以自定义过期时间，过期时间实际上就是监控单位时间。</li>
<li>取TP90或TP99时要向下取整，向上取整有可能超出数组范围，导致ArrayIndexOutOfBoundsException。</li>
</ul>
<h4 id="2-2属性类"><a href="#2-2属性类" class="headerlink" title="2.2属性类"></a>2.2属性类</h4><p>埋点属性类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jia.zheng.monitor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//方法调用属性类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Info</span> </span>&#123;</span><br><span class="line">    <span class="comment">//方法key</span></span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="comment">//方法开始时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> startTime;</span><br><span class="line">    <span class="comment">//方法调用成功与否</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Info</span><span class="params">(String serviceName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceName = serviceName;</span><br><span class="line">        <span class="keyword">this</span>.startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.state = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serviceName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getStartTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">boolean</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用时间数据类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jia.zheng.monitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Delayed;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CostTime</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> costTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CostTime</span><span class="params">(<span class="keyword">long</span> costTime, <span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.costTime = costTime;</span><br><span class="line">        <span class="keyword">this</span>.expireTime = System.currentTimeMillis() + delay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCostTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> costTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//重要：重写getDelay()方法，这是进行数据删除时的关键类，返回负值即为过期。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(<span class="keyword">this</span>.expireTime - System.currentTimeMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> CostTime c1 = (CostTime) o;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (<span class="keyword">this</span>.costTime - c1.costTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>过期数据删除时就是调用getDelay()方法，通过返回的long类型值判断数据是否过期。</li>
</ul>
<p>调用失败计数数据类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jia.zheng.monitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Delayed;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorCount</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorCount</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expireTime = System.currentTimeMillis() + delay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unit.convert(<span class="keyword">this</span>.expireTime - System.currentTimeMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>直接通过ErrorCount对象的个数来进行调用失败计数，所以该类中不需要额外属性，只需要expireTime用来计算过期时间即可。</li>
</ul>
<h4 id="2-3实验类"><a href="#2-3实验类" class="headerlink" title="2.3实验类"></a>2.3实验类</h4><p>模拟被调用方法类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jia.zheng.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceMethod</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">service</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//使用随机数来进行模拟，小于0.1假设为调用失败。</span></span><br><span class="line">        <span class="keyword">double</span> random = Math.random();</span><br><span class="line">        <span class="keyword">if</span> (random &lt; <span class="number">0.1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;<span class="comment">//调用成功，则用该随机数模拟服务调用时间。</span></span><br><span class="line">            Thread.sleep(Math.round(random * <span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟调用埋点类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jia.zheng.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jia.zheng.monitor.Info;</span><br><span class="line"><span class="keyword">import</span> jia.zheng.monitor.Monitor;</span><br><span class="line"><span class="keyword">import</span> jia.zheng.service.ServiceMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolVisit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ServiceMethod serviceMethod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重要：用线程池辅助模拟多线程并发调用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">100</span>, <span class="number">100</span>, <span class="number">0L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">50</span>));</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"visit"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">visit</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//循环调用，每次执行一个的调用任务。</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//每次调用适当休息一会，防止线程池不够用，会拒绝服务。</span></span><br><span class="line">            Thread.sleep(<span class="number">5</span>);</span><br><span class="line">            threadPoolExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Info info = Monitor.start(<span class="string">"testService"</span>);</span><br><span class="line">                        <span class="keyword">int</span> state = serviceMethod.service();</span><br><span class="line">                        <span class="keyword">if</span> (state == <span class="number">0</span>) &#123;</span><br><span class="line">                            Monitor.error(info);</span><br><span class="line">                        &#125;</span><br><span class="line">                        Monitor.end(info);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//执行两分钟</span></span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() - startTime &gt; <span class="number">2</span> * <span class="number">60</span> * <span class="number">1000</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行完毕！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重要：用一个定时器线程池来定时在计算并输出服务性能和可用率，每5s计算并输出一次。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        scheduledThreadPool.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//非常重要：线程池中runner的run()报错日志不会输出到控制台上，一定要用try-catch块抓住并打印异常信息。</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span>[] AP = Monitor.getAP(<span class="string">"testService"</span>);</span><br><span class="line">                    <span class="keyword">long</span>[] TP = Monitor.getTP(<span class="string">"testService"</span>);</span><br><span class="line">                    <span class="keyword">int</span> total = AP[<span class="number">0</span>] + AP[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">double</span> app;</span><br><span class="line">                    <span class="keyword">if</span> (AP[<span class="number">0</span>] != <span class="number">0</span> &amp;&amp; AP[<span class="number">1</span>] == <span class="number">0</span>) &#123;<span class="comment">//全部失败</span></span><br><span class="line">                        app = <span class="number">0</span>d;</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (AP[<span class="number">1</span>] == <span class="number">0</span>) &#123;<span class="comment">//还没有调用过</span></span><br><span class="line">                        app = <span class="number">100</span>d;</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        app = (<span class="keyword">double</span>) AP[<span class="number">1</span>] /total;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    System.out.println(<span class="string">"单位时间内总调用次数："</span> + total + <span class="string">"次------------可用率："</span> + app + <span class="string">"%------------性能TP90:"</span> + TP[<span class="number">0</span>] + <span class="string">"ms------------性能TP99:"</span> + TP[<span class="number">1</span>] +<span class="string">"ms"</span>);</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">10</span>, <span class="number">5</span>, TimeUnit.SECONDS);<span class="comment">//项目启动后延迟10s启动。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>此处用线程池辅助模拟多线程并发调用，这是非常巧妙的。</li>
<li>此处用一个定时器线程池来定时在计算并输出服务性能和可用率，每5s计算并输出一次。<strong>如果要添加告警机制也就是在此逻辑上添加的，计算完之后将性能值和可用率值与设定阈值进行比较，超出设定范围则执行报警逻辑。</strong></li>
<li><strong>线程池中任务的run()方法的报错日志不会输出到控制台上，一定要用try-catch块抓住异常并打印，才会将异常信息输出到控制台和日志文件中。</strong></li>
</ul>
<h4 id="2-4运行结果"><a href="#2-4运行结果" class="headerlink" title="2.4运行结果"></a>2.4运行结果</h4><p>启动springboot项目，10s观察控制台发现性能和可用率计算任务已经开始执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> &#x2F;\\ &#x2F; ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#39;_ | &#39;_| | &#39;_ \&#x2F; _&#96; | \ \ \ \</span><br><span class="line"> \\&#x2F;  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#39;  |____| .__|_| |_|_| |_\__, | &#x2F; &#x2F; &#x2F; &#x2F;</span><br><span class="line"> &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|_|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|___&#x2F;&#x3D;&#x2F;_&#x2F;_&#x2F;_&#x2F;</span><br><span class="line"> :: Spring Boot ::        (v2.1.5.RELEASE)</span><br><span class="line"></span><br><span class="line">2022-06-12 22:03:38.967  INFO 20628 --- [           main] jia.zheng.Application                    : Starting Application on LAPTOP-1D612HIP with PID 20628 (E:\files\IntelliJIDEA\TPMonitor\target\classes started by jiayue in E:\files\IntelliJIDEA\TPMonitor)</span><br><span class="line">2022-06-12 22:03:38.970  INFO 20628 --- [           main] jia.zheng.Application                    : No active profile set, falling back to default profiles: default</span><br><span class="line">2022-06-12 22:03:39.672  INFO 20628 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2022-06-12 22:03:39.686  INFO 20628 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2022-06-12 22:03:39.686  INFO 20628 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat&#x2F;9.0.19]</span><br><span class="line">2022-06-12 22:03:39.755  INFO 20628 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[&#x2F;]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-06-12 22:03:39.755  INFO 20628 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 756 ms</span><br><span class="line">2022-06-12 22:03:39.873  INFO 20628 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService &#39;applicationTaskExecutor&#39;</span><br><span class="line">2022-06-12 22:03:39.985  INFO 20628 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#39;&#39;</span><br><span class="line">2022-06-12 22:03:39.987  INFO 20628 --- [           main] jia.zheng.Application                    : Started Application in 1.307 seconds (JVM running for 2.227)</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br></pre></td></tr></table></figure>

<p><strong>浏览器访问，调用visit()方法，控制开可以看到监控数据中第1分钟内调用次数逐渐增加</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2022-06-12 22:05:21.468  INFO 20628 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[&#x2F;]       : Initializing Spring DispatcherServlet &#39;dispatcherServlet&#39;</span><br><span class="line">2022-06-12 22:05:21.469  INFO 20628 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#39;dispatcherServlet&#39;</span><br><span class="line">2022-06-12 22:05:21.473  INFO 20628 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 4 ms</span><br><span class="line">单位时间内总调用次数：493次------------可用率：0.9148073022312373%------------性能TP90:899ms------------性能TP99:990ms</span><br><span class="line">单位时间内总调用次数：1374次------------可用率：0.9017467248908297%------------性能TP90:902ms------------性能TP99:990ms</span><br><span class="line">单位时间内总调用次数：2249次------------可用率：0.9066251667407736%------------性能TP90:907ms------------性能TP99:990ms</span><br><span class="line">单位时间内总调用次数：3137次------------可用率：0.9034109021357986%------------性能TP90:910ms------------性能TP99:989ms</span><br></pre></td></tr></table></figure>

<p><strong>因为监控单元为1分钟，可以看到第2分钟内调用次数基本稳定</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">单位时间内总调用次数：11440次------------可用率：0.9009615384615385%------------性能TP90:913ms------------性能TP99:992ms</span><br><span class="line">单位时间内总调用次数：11452次------------可用率：0.9000174641983933%------------性能TP90:913ms------------性能TP99:992ms</span><br><span class="line">单位时间内总调用次数：11445次------------可用率：0.9010048055919616%------------性能TP90:910ms------------性能TP99:992ms</span><br><span class="line">单位时间内总调用次数：11453次------------可用率：0.9002008207456561%------------性能TP90:909ms------------性能TP99:992ms</span><br></pre></td></tr></table></figure>

<p><strong>因为我们模拟的调用多线程调用的总时间为2分钟，所以2分钟后没有调用了，可以看到第3分钟内调用次数逐渐下降</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">单位时间内总调用次数：7438次------------可用率：0.9005108900242%------------性能TP90:911ms------------性能TP99:991ms</span><br><span class="line">单位时间内总调用次数：6513次------------可用率：0.8988177491171503%------------性能TP90:915ms------------性能TP99:991ms</span><br><span class="line">单位时间内总调用次数：5630次------------可用率：0.9007104795737123%------------性能TP90:915ms------------性能TP99:992ms</span><br><span class="line">单位时间内总调用次数：4802次------------可用率：0.9014993752603082%------------性能</span><br></pre></td></tr></table></figure>

<p><strong>第四分钟后就没有调用了</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br><span class="line">单位时间内总调用次数：0次------------可用率：100.0%------------性能TP90:-1ms------------性能TP99:-1ms</span><br></pre></td></tr></table></figure>

<p><strong>此时再次浏览其访问或者前一次访问还没完成就再一次访问都可以看到预期中的并发效果</strong>，其中可用率和性能计算都符合预期。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag"><i class="fa fa-tag"></i> 线程池</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/06/08/%E5%95%86%E6%99%BA%E7%A6%BB%E7%BA%BF_%E4%BD%BF%E7%94%A8Guava%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81/" rel="next" title="商智离线_使用Guava缓存实现服务限流">
                <i class="fa fa-chevron-left"></i> 商智离线_使用Guava缓存实现服务限流
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/06/15/%E5%95%86%E6%99%BA%E7%A6%BB%E7%BA%BF_xml%E9%85%8D%E7%BD%AE%E5%AE%9E%E7%8E%B0Quartz%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E6%96%B9%E6%B3%95/" rel="prev" title="商智离线_xml配置实现Quartz执行jar包方法">
                商智离线_xml配置实现Quartz执行jar包方法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.jpg"
                alt="zju岩手县小森" />
            
              <p class="site-author-name" itemprop="name">zju岩手县小森</p>
              <p class="site-description motion-element" itemprop="description">看的远固然重要 但是走好眼前的路才是关键</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">105</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">107</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.instagram.com/littleforestjia" target="_blank" title="Instagram">
                      Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://space.bilibili.com/29623500" target="_blank" title="Bilibili">
                      Bilibili</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#商智离线-并发TP90-amp-TP99性能与可用率监控"><span class="nav-number">1.</span> <span class="nav-text">商智离线_并发TP90&amp;TP99性能与可用率监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-监控原理"><span class="nav-number">1.1.</span> <span class="nav-text">1.监控原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1基本概念"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2实现思路"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2实现思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-单机实例"><span class="nav-number">1.2.</span> <span class="nav-text">2.单机实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1监控方法类"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1监控方法类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2属性类"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2属性类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3实验类"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3实验类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4运行结果"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4运行结果</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zju岩手县小森</span>

  
</div>















        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
