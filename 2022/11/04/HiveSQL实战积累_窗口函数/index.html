<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="HiveSQL," />










<meta name="description" content="HiveSQL实战积累_窗口函数1.窗口函数基本概念1.1 窗口函数概述窗口函数能够使用一行或多行的值来返回每一行的值，出现在select子句的表达式列表中。over是关键字，用来指定函数执行的窗口范围，over关键字中包含三个分析子句：分组(partition by)、排序(order by)和Frame窗口区间。  如上图所示，将窗口函数与group by进行比较：group by就是使用聚合">
<meta property="og:type" content="article">
<meta property="og:title" content="HiveSQL实战积累_窗口函数">
<meta property="og:url" content="http://https//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/index.html">
<meta property="og:site_name" content="岩手县小森的博客">
<meta property="og:description" content="HiveSQL实战积累_窗口函数1.窗口函数基本概念1.1 窗口函数概述窗口函数能够使用一行或多行的值来返回每一行的值，出现在select子句的表达式列表中。over是关键字，用来指定函数执行的窗口范围，over关键字中包含三个分析子句：分组(partition by)、排序(order by)和Frame窗口区间。  如上图所示，将窗口函数与group by进行比较：group by就是使用聚合">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/1.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/2.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/3.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/4.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/5.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/6.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/7.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/8.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/9.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/10.png">
<meta property="og:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/11.png">
<meta property="article:published_time" content="2022-11-03T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-25T09:00:55.133Z">
<meta property="article:author" content="zju岩手县小森">
<meta property="article:tag" content="HiveSQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://https://littleforestjia.github.io/2022/11/04/HiveSQL实战积累_窗口函数/"/>





  <title>HiveSQL实战积累_窗口函数 | 岩手县小森的博客</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">岩手县小森的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力将眼前的每一天过得精彩</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://https://littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zju岩手县小森">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岩手县小森的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">HiveSQL实战积累_窗口函数</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-11-04T00:00:00+08:00">
                2022-11-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF/" itemprop="url" rel="index">
                    <span itemprop="name">HiveSQL实战积累</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="HiveSQL实战积累-窗口函数"><a href="#HiveSQL实战积累-窗口函数" class="headerlink" title="HiveSQL实战积累_窗口函数"></a>HiveSQL实战积累_窗口函数</h2><h3 id="1-窗口函数基本概念"><a href="#1-窗口函数基本概念" class="headerlink" title="1.窗口函数基本概念"></a>1.窗口函数基本概念</h3><h4 id="1-1-窗口函数概述"><a href="#1-1-窗口函数概述" class="headerlink" title="1.1 窗口函数概述"></a>1.1 窗口函数概述</h4><p>窗口函数能够使用一行或多行的值来返回每一行的值，出现在select子句的表达式列表中。over是关键字，用来指定函数执行的窗口范围，over关键字中包含三个分析子句：分组(partition by)、排序(order by)和Frame窗口区间。</p>
<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/1.png" alt></p>
<p><strong>如上图所示，将窗口函数与group by进行比较：group by就是使用聚合函数是将多条记录聚合为1条，窗口函数则是使用函数对圈定窗口中的数据进行计算然后得到计算值返回给每一行，不会改变原本的行数。</strong></p>
<p>窗口函数表达式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    函数名() <span class="keyword">over</span>([<span class="keyword">partition</span> <span class="keyword">by</span> &lt;要分组的列&gt;] [<span class="keyword">order</span> <span class="keyword">by</span> &lt;要排序的列&gt;] [Frame&lt;窗口区间&gt;]）</span><br><span class="line"></span><br><span class="line"><span class="keyword">over</span>关键字中每个部分都是可选的，eg:</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(<span class="keyword">value</span>) <span class="keyword">over</span>()</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> &lt;要分组的列&gt;) </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> &lt;要排序的列&gt;）</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> &lt;要分组的列&gt; <span class="keyword">order</span> <span class="keyword">by</span> &lt;要排序的列&gt;）</span><br></pre></td></tr></table></figure>

<p>窗口函数支持的函数类型：</p>
<ol>
<li>聚合函数：sum(…)、 count(…)、max(…)、min(…)、avg(…)</li>
<li>排序函数：rank( )、dense_rank( )、row_number( )</li>
<li>偏移分析函数：lead(…)、lag(…)、 first_value(…)、last_value(…)</li>
</ol>
<p>over关键字：</p>
<ol>
<li>partition by：分组的字段</li>
<li>order by：排序的字段（默认升序ASC）</li>
<li>Frame：窗口区间，用于指定计算数据的窗口边界，支持rows、range两种模式 </li>
</ol>
<h4 id="1-2-Frame窗口区间原理"><a href="#1-2-Frame窗口区间原理" class="headerlink" title="1.2 Frame窗口区间原理"></a>1.2 Frame窗口区间原理</h4><p><strong>按partition by分组字段相同的key得到的所有数据行即为窗口函数的窗口，可以进一步使用Frame窗口区间来对这个窗口中的数据进行划界，指定函数作用的数据范围。</strong></p>
<p>窗口示意图如下：</p>
<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/2.png" alt></p>
<p>其中各名词的含义如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">preceding              往前</span><br><span class="line">following              往后</span><br><span class="line">current row            当前行</span><br><span class="line">unbounded preceding    从前面的起点</span><br><span class="line">unbounded following    到后面的终点</span><br></pre></td></tr></table></figure>

<p>Frame窗口区间的两种写法是<code>rows/range between &lt;数据范围&gt;</code>，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rows/range between unbounded preceding and unbounded following <span class="comment">--取窗口中的所有行，这是不加order by排序字段时的默认计算范围</span></span><br><span class="line">rows/range between unbounded preceding and current row <span class="comment">--取本行和之前所有行，这是加order by排序字段时的默认计算范围</span></span><br><span class="line">rows/range between 2 preceding and current row <span class="comment">--取当前行和前面2行</span></span><br><span class="line">rows/range between 3 preceding and 1 following <span class="comment">--取前边3行+当前行+后边1行，共5行</span></span><br></pre></td></tr></table></figure>

<p>rows/range两种模式的区别：rows模式按物理行来进行划分，判断依据是行数；range模式按数值逻辑来进行行划分，要使用range模式的前提是有order by排序字段。如果例子很容易就可以看出区别：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    bs,</span><br><span class="line">    mins,</span><br><span class="line">    item_pv,</span><br><span class="line">    <span class="keyword">SUM</span>(item_pv) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> mins <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">row</span>) <span class="keyword">AS</span> <span class="keyword">rows</span>,</span><br><span class="line">    <span class="keyword">SUM</span>(item_pv) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> mins <span class="keyword">range</span> <span class="keyword">BETWEEN</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">row</span>) <span class="keyword">AS</span> <span class="keyword">range</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    app.app_d14_traffic_test_ftx</span><br></pre></td></tr></table></figure>

<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/3.png" alt></p>
<h3 id="2-窗口函数分类"><a href="#2-窗口函数分类" class="headerlink" title="2.窗口函数分类"></a>2.窗口函数分类</h3><h4 id="2-1-聚合函数"><a href="#2-1-聚合函数" class="headerlink" title="2.1 聚合函数"></a>2.1 聚合函数</h4><ol>
<li>count(*)：计算目标表中的所有行，包括null值。</li>
<li>count(col)：计算特定列或表达式中非null值的行数。</li>
<li>sum(col)：返回值的表达式总和，忽略null值。</li>
<li>max(col)/min(col)：返回输入表达式值中的最大/小值，忽略null值。</li>
<li>avg(col)：返回输入表达式值的平均值，忽略null值。</li>
</ol>
<p>应用实例sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  grades</span><br><span class="line">  ,subjects</span><br><span class="line">  ,results</span><br><span class="line">  ,<span class="keyword">sum</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">sum</span>聚合<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">sum</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects) <span class="keyword">as</span> <span class="keyword">sum</span>聚合<span class="number">2</span></span><br><span class="line">  ,<span class="keyword">count</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">count</span>聚合<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">count</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects) <span class="keyword">as</span> <span class="keyword">count</span>聚合<span class="number">2</span></span><br><span class="line">  ,<span class="keyword">min</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">min</span>聚合<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">min</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects) <span class="keyword">as</span> <span class="keyword">min</span>聚合<span class="number">2</span></span><br><span class="line">  ,<span class="keyword">max</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">max</span>聚合<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">max</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects) <span class="keyword">as</span> <span class="keyword">max</span>聚合<span class="number">2</span></span><br><span class="line">  ,<span class="keyword">avg</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">avg</span>聚合<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">avg</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects) <span class="keyword">as</span> <span class="keyword">avg</span>聚合<span class="number">2</span></span><br><span class="line"><span class="keyword">from</span> test11</span><br></pre></td></tr></table></figure>

<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/4.png" alt></p>
<p>其中聚合1表示将数据集按照grades、subjects进行分组后，按照results降序排序，将每组中的results依次聚合；聚合2表示将数据集按照grades、subjects进行分组后，将每组中的results整体聚合。<strong>其中聚合1与聚合2的差异来源于order by排序字段的默认Frame窗口区间，有order by的默认窗口区间是rows between unbounded preceding and current row，没有order by的默认窗口区间是rows between unbounded preceding and unbounded following。也可以在聚合1的over关键字最后加上窗口区间rows between unbounded preceding and unbounded following，使得聚合1与聚合2的计算结果相同。</strong></p>
<h4 id="2-2-排序函数"><a href="#2-2-排序函数" class="headerlink" title="2.2 排序函数"></a>2.2 排序函数</h4><ol>
<li>rank( )：bigint类型，形如1，2，2，4…(序号可以重复，序号不连续)，排名，占用下一名次的位置。</li>
<li>dense_rank( )：bigint类型，形如：1，2，2，3…(序号可以重复，序号连续)，排名，不占用下一名次的位置。</li>
<li>row_number( )：bigint类型，形如：1，2，3，4…(序号不重复，序号连续)，编号。</li>
<li>cume_dist()：double类型，分组内小于等于当前rank的行值/分组内的总行数(查询&lt;=当前计算值的比例)，重复值取重复值最后一行位置(0,1]。</li>
<li>percent_rank()：double类型，返回数据集中每个数据的排名百分比，可以用来计算超过了百分之多少的人，排名计算公式为：(当前行的rank值-1)/(分组内的总行数-1)，重复值取重复值第一行位置[0,1]。</li>
<li>ntile(n)：bigint类型，将每个窗口分区的数据分散到桶号从1到n的n个桶中。</li>
</ol>
<p>应用实例sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  grades</span><br><span class="line">  ,subjects</span><br><span class="line">  ,results</span><br><span class="line">  ,row_number() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> row_numbers</span><br><span class="line">  ,<span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> ranks</span><br><span class="line">  ,<span class="keyword">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> dense_ranks</span><br><span class="line">  ,ntile(<span class="number">3</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> ntiles</span><br><span class="line"><span class="keyword">from</span> test11</span><br></pre></td></tr></table></figure>

<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/5.png" alt></p>
<h4 id="2-3-偏移分析函数"><a href="#2-3-偏移分析函数" class="headerlink" title="2.3 偏移分析函数"></a>2.3 偏移分析函数</h4><ol>
<li>lead(col,n,m)：返回当前行的后n行，lead(要取的列, 往下取n行(可选，默认为1)，如果没有下一行默认null)。</li>
<li>lag(col,n,m)：返回当前行的前n行，lead(要取的列, 往上取n行(可选，默认为1)，如果没有上一行默认null)。</li>
<li>first_value()：取分组内排序后，截止到当前行的第一个值，默认窗口区间为rows between unbounded preceding and current row。</li>
<li>last_value()：取分组内排序后，截止到当前行的最后一个值，默认窗口区间为rows between unbounded preceding and current row。</li>
</ol>
<p>应用实例sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  grades</span><br><span class="line">  ,subjects</span><br><span class="line">  ,results</span><br><span class="line">  ,lag(results,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> lag移位<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">lead</span>(results,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">lead</span>移位<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">first_value</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">first_value</span>排序<span class="number">1</span></span><br><span class="line">  ,<span class="keyword">last_value</span>(results) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> grades,subjects <span class="keyword">order</span> <span class="keyword">by</span> results <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">last_value</span>排序<span class="number">1</span></span><br><span class="line"><span class="keyword">from</span> test11</span><br></pre></td></tr></table></figure>

<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/6.png" alt></p>
<p><strong>加order by排序字段代表将数据集按照grades、subjects进行分组后，再根据results降序排序，然后以默认窗口区间rows between unbounded preceding and current row进行运算。若不加order by则是对分组后的数据直接运算，也就是默认窗口区间rows between unbounded preceding and unbounded following。</strong></p>
<h3 id="3-partitionBy-amp-distributeBy区别"><a href="#3-partitionBy-amp-distributeBy区别" class="headerlink" title="3.partitionBy&amp;distributeBy区别"></a>3.partitionBy&amp;distributeBy区别</h3><h4 id="3-1-order-by全局排序"><a href="#3-1-order-by全局排序" class="headerlink" title="3.1 order by全局排序"></a>3.1 order by全局排序</h4><p>order by会对数据进行一次全局排序，只要hivesql中指定了order by，那么最后所有的数据都会到同一个reducer进行排序处理，所以数据量特别大的时候效率非常低。</p>
<h4 id="3-2-sort-by局部排序"><a href="#3-2-sort-by局部排序" class="headerlink" title="3.2 sort by局部排序"></a>3.2 sort by局部排序</h4><p>sort by在每个reducer端都会做排序，为每个reduce产生一个排序文件，也就是说sort by能保证局部有序，就是每个reducer出来的数据是有序的，但是不能保证所有的数据是有序的，除非只有一个reducer。使用sort by的好处是，执行了局部排序之后可以为接下去的全局排序提高不少的效率。</p>
<h4 id="3-3-distribute-by分区"><a href="#3-3-distribute-by分区" class="headerlink" title="3.3 distribute by分区"></a>3.3 distribute by分区</h4><p>distribute by是控制map的输出在reducer是如何划分的，可以控制某个特定数据行应该到哪个reducer。默认情况下采集hash算法，将map端输出数据中hash值相同的结果分发到同一个reducer上。</p>
<p>distribute by经常和sort by配合使用。</p>
<h4 id="3-4-group-by"><a href="#3-4-group-by" class="headerlink" title="3.4 group by"></a>3.4 group by</h4><p>group by和distribute by类似 都是按key值划分数据到不同reduce进行处理。唯一不同的是，distribute by只是单纯的分散数据；而group by是为了把相同key的数据聚集到一起<strong>，</strong>后续必须是聚合操作。</p>
<h4 id="3-5-cluster-by"><a href="#3-5-cluster-by" class="headerlink" title="3.5 cluster by"></a>3.5 cluster by</h4><p>cluster by 除了distribute by 的功能外，还会对该字段进行排序。所以distribute by和 sort by合用且by相同字段就相当于cluster by，但是cluster by不能指定排序为asc或 desc的规则，只能是升序排列。</p>
<h4 id="3-6-distribute-by与partition-by的区别"><a href="#3-6-distribute-by与partition-by的区别" class="headerlink" title="3.6 distribute by与partition by的区别"></a>3.6 distribute by与partition by的区别</h4><p><strong>partition by不能用在where后面，partition by只能与order by配合在窗口函数中使用，而distribute by在窗口函数和where后面都可以使用。在窗口函数中partition by [key..] order by [key..]和distribute by [key…] sort by [key…]两者没有任何区别。</strong></p>
<h3 id="4-分时累积预计算实战"><a href="#4-分时累积预计算实战" class="headerlink" title="4.分时累积预计算实战"></a>4.分时累积预计算实战</h3><h4 id="4-1-数据加工路径"><a href="#4-1-数据加工路径" class="headerlink" title="4.1 数据加工路径"></a>4.1 数据加工路径</h4><p>实时离线对比页面或者单日趋势图页面经常需要用到分时累计数据，此处以单日10分钟累计流量指标pv、uv预计算为例，展示窗口函数在分时累计预计算中的使用，加工路径如下图所示：</p>
<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/7.png" alt></p>
<p>图中的时间断点是指，某些时间区间内没有pv或uv，导致采用窗口函数累加得到的数据表中，没有该时间维度行；uv断点是指某些时间区间内有pv但是没有uv，导致累加完之后的两指标合并之后，该时间维度行的uv为0或空。</p>
<h4 id="4-2-指标分时统计再窗口函数累加"><a href="#4-2-指标分时统计再窗口函数累加" class="headerlink" title="4.2 指标分时统计再窗口函数累加"></a>4.2 指标分时统计再窗口函数累加</h4><p>sql实例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	dt,</span><br><span class="line">	bs,</span><br><span class="line">	interval_index,</span><br><span class="line">	<span class="keyword">SUM</span>(item_pv_10min_aggr) <span class="keyword">AS</span> item_pv_10min_aggr,</span><br><span class="line">	<span class="keyword">SUM</span>(item_uv_10min_aggr) <span class="keyword">AS</span> item_uv_10min_aggr,</span><br><span class="line">	<span class="number">0</span> <span class="keyword">AS</span> item_rt_10min_aggr,</span><br><span class="line">	<span class="number">0</span> <span class="keyword">AS</span> item_login_users_10min_aggr</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			dt,</span><br><span class="line">			bs,</span><br><span class="line">			interval_index,</span><br><span class="line">			<span class="keyword">SUM</span>(item_pv_10min_aggr) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">BY</span> dt, bs <span class="keyword">order</span> <span class="keyword">by</span> interval_index) <span class="keyword">AS</span> item_pv_10min_aggr,</span><br><span class="line">			<span class="number">0</span> <span class="keyword">AS</span> item_uv_10min_aggr</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			(</span><br><span class="line">				<span class="keyword">SELECT</span></span><br><span class="line">					dt,</span><br><span class="line">					arrayJoin(<span class="keyword">IF</span>(bs = <span class="string">'7710'</span>, [<span class="string">'7710'</span>, <span class="string">'77'</span>], [bs])) <span class="keyword">AS</span> bs,</span><br><span class="line">					<span class="keyword">concat</span>(REGEXP_REPLACE(dt, <span class="string">'-'</span>, <span class="string">''</span>), leftPad(toString(toInt32(toInt32(mins) / <span class="number">6</span>)), <span class="number">2</span>, <span class="string">'0'</span>), leftPad(toString(<span class="number">10</span> *((mins) %<span class="number">6</span>)), <span class="number">2</span>, <span class="string">'0'</span>)) <span class="keyword">AS</span> interval_index,</span><br><span class="line">					<span class="keyword">SUM</span>(item_pv) item_pv_10min_aggr</span><br><span class="line">				<span class="keyword">FROM</span></span><br><span class="line">					app.app_d14_traffic_plat_item_di_new_opt_aggr_d</span><br><span class="line">				<span class="keyword">WHERE</span></span><br><span class="line">					dt &gt;= <span class="string">'2021-10-31'</span></span><br><span class="line">					<span class="keyword">AND</span> dt &lt;= <span class="string">'2021-10-31'</span></span><br><span class="line">					<span class="keyword">AND</span> bs = <span class="string">'1302'</span></span><br><span class="line">					<span class="keyword">AND</span> cate_bu_id = <span class="string">'6210'</span></span><br><span class="line">					<span class="keyword">AND</span> mins &lt;= <span class="number">76</span></span><br><span class="line">				<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">					dt,</span><br><span class="line">					bs,</span><br><span class="line">					interval_index</span><br><span class="line">			)</span><br><span class="line">			t</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			dt,</span><br><span class="line">			bs,</span><br><span class="line">			interval_index,</span><br><span class="line">			<span class="number">0</span> <span class="keyword">AS</span> item_pv_10min_aggr,</span><br><span class="line">			<span class="keyword">SUM</span>(item_uv_10min_aggr) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">BY</span> dt, bs <span class="keyword">order</span> <span class="keyword">by</span> interval_index) <span class="keyword">AS</span> item_uv_10min_aggr</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			(</span><br><span class="line">				<span class="keyword">SELECT</span></span><br><span class="line">					dt,</span><br><span class="line">					bs,</span><br><span class="line">					interval_index,</span><br><span class="line">					<span class="keyword">COUNT</span>( *) <span class="keyword">AS</span> item_uv_10min_aggr</span><br><span class="line">				<span class="keyword">FROM</span></span><br><span class="line">					(</span><br><span class="line">						<span class="keyword">SELECT</span></span><br><span class="line">							dt,</span><br><span class="line">							arrayJoin(<span class="keyword">IF</span>(bs = <span class="string">'7710'</span>, [<span class="string">'7710'</span>, <span class="string">'77'</span>], [bs])) <span class="keyword">AS</span> bs,</span><br><span class="line">							bs_browser_uniq_id,</span><br><span class="line">							<span class="keyword">MIN</span>(<span class="keyword">concat</span>(REGEXP_REPLACE(dt, <span class="string">'-'</span>, <span class="string">''</span>), leftPad(toString(toInt32(toInt32(mins) / <span class="number">6</span>)), <span class="number">2</span>, <span class="string">'0'</span>), leftPad(toString(<span class="number">10</span> *((mins) %<span class="number">6</span>)), <span class="number">2</span>, <span class="string">'0'</span>))) <span class="keyword">AS</span> interval_index</span><br><span class="line">						<span class="keyword">FROM</span></span><br><span class="line">							app.app_d14_traffic_plat_item_di_new_opt_aggr_d</span><br><span class="line">						<span class="keyword">WHERE</span></span><br><span class="line">							dt &gt;= <span class="string">'2021-10-31'</span></span><br><span class="line">							<span class="keyword">AND</span> dt &lt;= <span class="string">'2021-10-31'</span></span><br><span class="line">							<span class="keyword">AND</span> bs = <span class="string">'1302'</span></span><br><span class="line">							<span class="keyword">AND</span> cate_bu_id = <span class="string">'6210'</span></span><br><span class="line">							<span class="keyword">AND</span> mins &lt;= <span class="number">76</span></span><br><span class="line">						<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">							dt,</span><br><span class="line">							bs,</span><br><span class="line">							bs_browser_uniq_id</span><br><span class="line">					)</span><br><span class="line">					t</span><br><span class="line">				<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">					dt,</span><br><span class="line">					bs,</span><br><span class="line">					interval_index</span><br><span class="line">			)</span><br><span class="line">			tt</span><br><span class="line">	)</span><br><span class="line">	ttt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	dt,</span><br><span class="line">	bs,</span><br><span class="line">	interval_index</span><br></pre></td></tr></table></figure>

<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/8.png" alt></p>
<p>分别使用窗口函数累加得到的pv和uv如上图所示，明显可以看出存在时间断点，且pv数据条数比uv数据条数要多，将两个指标合并之后，可以看出存在uv断点，如下图所示。</p>
<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/9.png" alt></p>
<h4 id="4-3-join时间维表补全断点"><a href="#4-3-join时间维表补全断点" class="headerlink" title="4.3 join时间维表补全断点"></a>4.3 join时间维表补全断点</h4><p>sql实例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	dt,</span><br><span class="line">	bs,</span><br><span class="line">	<span class="keyword">concat</span>(REGEXP_REPLACE(dt, <span class="string">'-'</span>, <span class="string">''</span>), leftPad(toString(toInt32(toInt32(mins) / <span class="number">6</span>)),<span class="number">2</span>,<span class="string">'0'</span>), leftPad(toString(<span class="number">10</span> *((mins) %<span class="number">6</span>)),<span class="number">2</span>,<span class="string">'0'</span>)) <span class="keyword">as</span> interval_index,</span><br><span class="line">	<span class="keyword">MAX</span>(item_pv_10min_aggr) <span class="keyword">as</span> item_pv_10min_aggr,</span><br><span class="line">	<span class="keyword">MAX</span>(item_uv_10min_aggr) <span class="keyword">as</span> item_uv_10min_aggr,</span><br><span class="line">	<span class="number">0</span> <span class="keyword">as</span> item_rt_10min_aggr,</span><br><span class="line">	<span class="number">0</span> <span class="keyword">as</span> item_login_users_10min_aggr</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line">	<span class="keyword">SELECT</span></span><br><span class="line">		g_mins <span class="keyword">as</span> mins,</span><br><span class="line">		d_mins</span><br><span class="line">	<span class="keyword">from</span></span><br><span class="line">		app.app_full_aggr_dim_d) aggr_dim</span><br><span class="line"><span class="keyword">join</span> (</span><br><span class="line">	<span class="keyword">select</span></span><br><span class="line">		dt,</span><br><span class="line">		bs,</span><br><span class="line">		interval_index,</span><br><span class="line">		<span class="keyword">SUM</span>(item_pv_10min_aggr) <span class="keyword">as</span> item_pv_10min_aggr,</span><br><span class="line">		<span class="keyword">SUM</span>(item_uv_10min_aggr) <span class="keyword">as</span> item_uv_10min_aggr,</span><br><span class="line">		<span class="number">0</span> <span class="keyword">as</span> item_rt_10min_aggr,</span><br><span class="line">		<span class="number">0</span> <span class="keyword">as</span> item_login_users_10min_aggr</span><br><span class="line">	<span class="keyword">from</span></span><br><span class="line">		(</span><br><span class="line">		<span class="keyword">select</span></span><br><span class="line">			dt,</span><br><span class="line">			bs,</span><br><span class="line">			interval_index,</span><br><span class="line">			<span class="keyword">sum</span>(item_pv_10min_aggr) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> dt,</span><br><span class="line">			bs</span><br><span class="line">		<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">			interval_index) <span class="keyword">as</span> item_pv_10min_aggr,</span><br><span class="line">			<span class="number">0</span> <span class="keyword">as</span> item_uv_10min_aggr</span><br><span class="line">		<span class="keyword">from</span></span><br><span class="line">			(</span><br><span class="line">			<span class="keyword">select</span></span><br><span class="line">				dt,</span><br><span class="line">				arrayJoin(<span class="keyword">if</span>(bs = <span class="string">'7710'</span>,[<span class="string">'7710'</span>,<span class="string">'77'</span>],[bs])) <span class="keyword">as</span> bs,</span><br><span class="line">				mins <span class="keyword">as</span> interval_index,</span><br><span class="line">				<span class="keyword">sum</span>(item_pv) item_pv_10min_aggr</span><br><span class="line">			<span class="keyword">from</span></span><br><span class="line">				app.app_d14_traffic_plat_item_di_new_opt_aggr_d</span><br><span class="line">			<span class="keyword">WHERE</span></span><br><span class="line">				dt &gt;= <span class="string">'2021-10-31'</span></span><br><span class="line">				<span class="keyword">AND</span> dt &lt;= <span class="string">'2021-10-31'</span></span><br><span class="line">				<span class="keyword">AND</span> bs = <span class="string">'1302'</span></span><br><span class="line">				<span class="keyword">AND</span> cate_bu_id = <span class="string">'6210'</span></span><br><span class="line">			<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">				dt,</span><br><span class="line">				bs,</span><br><span class="line">				interval_index) t</span><br><span class="line">	<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		<span class="keyword">select</span></span><br><span class="line">			dt,</span><br><span class="line">			bs,</span><br><span class="line">			interval_index,</span><br><span class="line">			<span class="number">0</span> <span class="keyword">as</span> item_pv_10min_aggr,</span><br><span class="line">			<span class="keyword">sum</span>(item_uv_10min_aggr) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> dt,</span><br><span class="line">			bs</span><br><span class="line">		<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">			interval_index) <span class="keyword">as</span> item_uv_10min_aggr</span><br><span class="line">		<span class="keyword">from</span></span><br><span class="line">			(</span><br><span class="line">			<span class="keyword">select</span></span><br><span class="line">				dt,</span><br><span class="line">				bs,</span><br><span class="line">				interval_index,</span><br><span class="line">				<span class="keyword">count</span>(*) <span class="keyword">as</span> item_uv_10min_aggr</span><br><span class="line">			<span class="keyword">from</span></span><br><span class="line">				(</span><br><span class="line">				<span class="keyword">select</span></span><br><span class="line">					dt,</span><br><span class="line">					arrayJoin(<span class="keyword">if</span>(bs = <span class="string">'7710'</span>,[<span class="string">'7710'</span>,<span class="string">'77'</span>],[bs])) <span class="keyword">as</span> bs,</span><br><span class="line">					bs_browser_uniq_id,</span><br><span class="line">					<span class="keyword">min</span>(mins) <span class="keyword">as</span> interval_index</span><br><span class="line">				<span class="keyword">from</span></span><br><span class="line">					app.app_d14_traffic_plat_item_di_new_opt_aggr_d</span><br><span class="line">				<span class="keyword">WHERE</span></span><br><span class="line">					dt &gt;= <span class="string">'2021-10-31'</span></span><br><span class="line">					<span class="keyword">AND</span> dt &lt;= <span class="string">'2021-10-31'</span></span><br><span class="line">					<span class="keyword">AND</span> bs = <span class="string">'1302'</span></span><br><span class="line">					<span class="keyword">AND</span> cate_bu_id = <span class="string">'6210'</span></span><br><span class="line">				<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">					dt,</span><br><span class="line">					bs,</span><br><span class="line">					bs_browser_uniq_id) t</span><br><span class="line">			<span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">				dt,</span><br><span class="line">				bs,</span><br><span class="line">				interval_index)tt)ttt</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">		dt,</span><br><span class="line">		bs,</span><br><span class="line">		interval_index) aggr <span class="keyword">on</span></span><br><span class="line">	aggr_dim.d_mins = aggr.interval_index</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">	dt,</span><br><span class="line">	bs,</span><br><span class="line">	interval_index</span><br></pre></td></tr></table></figure>

<p>此处通过join时间维表得到笛卡尔积将数据爆炸开来，其中时间维表存储的数据格式类似如下表：</p>
<table>
<thead>
<tr>
<th>g_mins</th>
<th>d_mins</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
</tr>
</tbody></table>
<p>运行sql补全时间和uv断点，得到计算结果如下图所示：</p>
<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/10.png" alt></p>
<h3 id="5-串行窗口函数优化实战"><a href="#5-串行窗口函数优化实战" class="headerlink" title="5.串行窗口函数优化实战"></a>5.串行窗口函数优化实战</h3><h4 id="5-1-单个select中多个窗口函数执行顺序"><a href="#5-1-单个select中多个窗口函数执行顺序" class="headerlink" title="5.1 单个select中多个窗口函数执行顺序"></a>5.1 单个select中多个窗口函数执行顺序</h4><p><strong>对于窗口函数，优化器能做的优化有限，首先会把窗口函数从project中抽取出来，成为一个独立的算子称之为window，窗口函数的窗口数据定义由over关键字中的partition by字段和order by字段共同决定。当一个select语句中包含多个窗口函数，它们的数据窗口可能相同，也可能不相同，只有分区和排序都一样才是相同的数据窗口。对于窗口相同的窗口函数可以在同一个window算子中执行，对于窗口的窗口函数，优化器会将它们分成不同的window算子，每次执行之前都要重新分区和排序，且这些window算子必须串行执行，如下图所示。</strong></p>
<p><img src="//littleforestjia.github.io/2022/11/04/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/11.png" alt></p>
<h4 id="5-2-串行窗口函数优化实例"><a href="#5-2-串行窗口函数优化实例" class="headerlink" title="5.2 串行窗口函数优化实例"></a>5.2 串行窗口函数优化实例</h4><p><strong>以如下使用窗口函数计算两个排名的sql为例，通过explain执行计划可以看出两个窗口函数是顺序执行的，可想而知当窗口函数数量增多，计算时间也会正比例增长。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	item_third_cate_cd,</span><br><span class="line">	item_sku_id,</span><br><span class="line">	terminal_type,</span><br><span class="line">	trade_type,</span><br><span class="line">	main_brand_id,</span><br><span class="line">	price_band_id,</span><br><span class="line">	row_number() <span class="keyword">over</span>(<span class="keyword">distribute</span> <span class="keyword">BY</span> terminal_type, price_band_id, trade_type, item_third_cate_cd <span class="keyword">sort</span> <span class="keyword">by</span> uv <span class="keyword">DESC</span>, pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> uv_sku_rank,</span><br><span class="line">	row_number() <span class="keyword">over</span>(<span class="keyword">distribute</span> <span class="keyword">BY</span> terminal_type, price_band_id, trade_type, item_third_cate_cd, main_brand_id <span class="keyword">sort</span> <span class="keyword">by</span> uv <span class="keyword">DESC</span>, pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> uv_sku_brand_rnak</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	adm.adm_zh_industry_sku_index_all_ref</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	dt = <span class="string">'2023-03-03'</span></span><br><span class="line">	<span class="keyword">AND</span> stat_ct_cd = <span class="string">'day'</span>;</span><br></pre></td></tr></table></figure>

<p>执行计划如下，两个window算子分别在satge-1和stage-2中，这两个stage为父子关系：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Explain</span></span><br><span class="line">STAGE DEPENDENCIES:</span><br><span class="line">  Stage<span class="number">-1</span> <span class="keyword">is</span> a root stage</span><br><span class="line">  Stage<span class="number">-2</span> depends <span class="keyword">on</span> stages: Stage<span class="number">-1</span></span><br><span class="line">  Stage<span class="number">-0</span> depends <span class="keyword">on</span> stages: Stage<span class="number">-2</span></span><br><span class="line"></span><br><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage<span class="number">-1</span></span><br><span class="line">    <span class="keyword">Map</span> Reduce</span><br><span class="line">      <span class="keyword">Map</span> <span class="keyword">Operator</span> Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="keyword">alias</span>: adm_zh_industry_sku_index_all_ref</span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            Filter <span class="keyword">Operator</span></span><br><span class="line">              predicate: ((dt = <span class="string">'2023-03-03'</span>) <span class="keyword">and</span> (stat_ct_cd = <span class="string">'day'</span>)) (<span class="keyword">type</span>: <span class="built_in">boolean</span>)</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              Reduce <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                <span class="keyword">key</span> expressions: terminal_type (<span class="keyword">type</span>: <span class="built_in">int</span>), price_band_id (<span class="keyword">type</span>: <span class="keyword">string</span>), trade_type (<span class="keyword">type</span>: <span class="keyword">string</span>), item_third_cate_cd (<span class="keyword">type</span>: <span class="keyword">string</span>), uv (<span class="keyword">type</span>: <span class="built_in">bigint</span>), pv (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">                <span class="keyword">sort</span> <span class="keyword">order</span>: ++++<span class="comment">--</span></span><br><span class="line">                <span class="keyword">Map</span>-reduce <span class="keyword">partition</span> <span class="keyword">columns</span>: terminal_type (<span class="keyword">type</span>: <span class="built_in">int</span>), price_band_id (<span class="keyword">type</span>: <span class="keyword">string</span>), trade_type (<span class="keyword">type</span>: <span class="keyword">string</span>), item_third_cate_cd (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                <span class="keyword">value</span> expressions: item_sku_id (<span class="keyword">type</span>: <span class="built_in">bigint</span>), main_brand_id (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">      Reduce <span class="keyword">Operator</span> Tree:</span><br><span class="line">        <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">          expressions: KEY.reducesinkkey3 (<span class="keyword">type</span>: <span class="keyword">string</span>), VALUE._col5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey0 (<span class="keyword">type</span>: <span class="built_in">int</span>), KEY.reducesinkkey2 (<span class="keyword">type</span>: <span class="keyword">string</span>), VALUE._col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey1 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey4 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">          outputColumnNames: _col4, _col6, _col8, _col9, _col12, _col17, _col19, _col20</span><br><span class="line">          <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">          PTF <span class="keyword">Operator</span></span><br><span class="line">            <span class="keyword">Function</span> definitions:</span><br><span class="line">                <span class="keyword">Input</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_0</span><br><span class="line">                  <span class="keyword">output</span> shape: _col4: <span class="keyword">string</span>, _col6: <span class="built_in">bigint</span>, _col8: <span class="built_in">int</span>, _col9: <span class="keyword">string</span>, _col12: <span class="keyword">string</span>, _col17: <span class="keyword">string</span>, _col19: <span class="built_in">bigint</span>, _col20: <span class="built_in">bigint</span></span><br><span class="line">                  <span class="keyword">type</span>: WINDOWING</span><br><span class="line">                Windowing <span class="keyword">table</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_1</span><br><span class="line">                  <span class="keyword">name</span>: windowingtablefunction</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span>: _col20(<span class="keyword">DESC</span>), _col19(<span class="keyword">DESC</span>)</span><br><span class="line">                  <span class="keyword">partition</span> <span class="keyword">by</span>: _col8, _col17, _col9, _col4</span><br><span class="line">                  <span class="keyword">raw</span> <span class="keyword">input</span> shape:</span><br><span class="line">                  <span class="keyword">window</span> functions:</span><br><span class="line">                      <span class="keyword">window</span> <span class="keyword">function</span> definition</span><br><span class="line">                        <span class="keyword">alias</span>: row_number_window_0</span><br><span class="line">                        <span class="keyword">name</span>: row_number</span><br><span class="line">                        <span class="keyword">window</span> <span class="keyword">function</span>: GenericUDAFRowNumberEvaluator</span><br><span class="line">                        <span class="keyword">window</span> frame: <span class="keyword">PRECEDING</span>(<span class="keyword">MAX</span>)~<span class="keyword">FOLLOWING</span>(<span class="keyword">MAX</span>)</span><br><span class="line">                        isPivotResult: <span class="literal">true</span></span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">              expressions: _col12 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col17 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col19 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col20 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col8 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), row_number_window_0 (<span class="keyword">type</span>: <span class="built_in">int</span>)</span><br><span class="line">              outputColumnNames: _col12, _col17, _col19, _col20, _col4, _col6, _col8, _col9, row_number_window_0</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">File</span> <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                <span class="keyword">table</span>:</span><br><span class="line">                    <span class="keyword">input</span> <span class="keyword">format</span>: org.apache.hadoop.mapred.SequenceFileInputFormat</span><br><span class="line">                    <span class="keyword">output</span> <span class="keyword">format</span>: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage<span class="number">-2</span></span><br><span class="line">    <span class="keyword">Map</span> Reduce</span><br><span class="line">      <span class="keyword">Map</span> <span class="keyword">Operator</span> Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            Reduce <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">              <span class="keyword">key</span> expressions: _col8 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col17 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col12 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col20 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col19 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">              <span class="keyword">sort</span> <span class="keyword">order</span>: +++++<span class="comment">--</span></span><br><span class="line">              <span class="keyword">Map</span>-reduce <span class="keyword">partition</span> <span class="keyword">columns</span>: _col8 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col17 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col12 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">value</span> expressions: row_number_window_0 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">      Reduce <span class="keyword">Operator</span> Tree:</span><br><span class="line">        <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">          expressions: VALUE._col0 (<span class="keyword">type</span>: <span class="built_in">int</span>), KEY.reducesinkkey3 (<span class="keyword">type</span>: <span class="keyword">string</span>), VALUE._col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey0 (<span class="keyword">type</span>: <span class="built_in">int</span>), KEY.reducesinkkey2 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey4 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey1 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">          outputColumnNames: _col0, _col5, _col7, _col9, _col10, _col13, _col18, _col20, _col21</span><br><span class="line">          <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">          PTF <span class="keyword">Operator</span></span><br><span class="line">            <span class="keyword">Function</span> definitions:</span><br><span class="line">                <span class="keyword">Input</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_0</span><br><span class="line">                  <span class="keyword">output</span> shape: _col0: <span class="built_in">int</span>, _col5: <span class="keyword">string</span>, _col7: <span class="built_in">bigint</span>, _col9: <span class="built_in">int</span>, _col10: <span class="keyword">string</span>, _col13: <span class="keyword">string</span>, _col18: <span class="keyword">string</span>, _col20: <span class="built_in">bigint</span>, _col21: <span class="built_in">bigint</span></span><br><span class="line">                  <span class="keyword">type</span>: WINDOWING</span><br><span class="line">                Windowing <span class="keyword">table</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_1</span><br><span class="line">                  <span class="keyword">name</span>: windowingtablefunction</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span>: _col21(<span class="keyword">DESC</span>), _col20(<span class="keyword">DESC</span>)</span><br><span class="line">                  <span class="keyword">partition</span> <span class="keyword">by</span>: _col9, _col18, _col10, _col5, _col13</span><br><span class="line">                  <span class="keyword">raw</span> <span class="keyword">input</span> shape:</span><br><span class="line">                  <span class="keyword">window</span> functions:</span><br><span class="line">                      <span class="keyword">window</span> <span class="keyword">function</span> definition</span><br><span class="line">                        <span class="keyword">alias</span>: row_number_window_1</span><br><span class="line">                        <span class="keyword">name</span>: row_number</span><br><span class="line">                        <span class="keyword">window</span> <span class="keyword">function</span>: GenericUDAFRowNumberEvaluator</span><br><span class="line">                        <span class="keyword">window</span> frame: <span class="keyword">PRECEDING</span>(<span class="keyword">MAX</span>)~<span class="keyword">FOLLOWING</span>(<span class="keyword">MAX</span>)</span><br><span class="line">                        isPivotResult: <span class="literal">true</span></span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">              expressions: _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col7 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col9 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col10 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col13 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col18 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col0 (<span class="keyword">type</span>: <span class="built_in">int</span>), row_number_window_1 (<span class="keyword">type</span>: <span class="built_in">int</span>)</span><br><span class="line">              outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">File</span> <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                <span class="keyword">table</span>:</span><br><span class="line">                    <span class="keyword">input</span> <span class="keyword">format</span>: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                    <span class="keyword">output</span> <span class="keyword">format</span>: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage<span class="number">-0</span></span><br><span class="line">    <span class="keyword">Fetch</span> <span class="keyword">Operator</span></span><br><span class="line">      <span class="keyword">limit</span>: <span class="number">-1</span></span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure>

<p><strong>使用union all+sum() group by对上述sql进行改造如下，则union all上下的两个select可以并发执行，实现了window算子的并发执行。这种方法的并发度更高，执行速度更快，但是对计算资源的要求也更高。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	item_third_cate_cd, <span class="comment">--三级类目id</span></span><br><span class="line">	item_sku_id, <span class="comment">--商品编码</span></span><br><span class="line">	terminal_type, <span class="comment">--渠道</span></span><br><span class="line">	trade_type, <span class="comment">--经营模式</span></span><br><span class="line">	main_brand_id, <span class="comment">--主品牌id</span></span><br><span class="line">	price_band_id, <span class="comment">--价格带id</span></span><br><span class="line">	<span class="keyword">SUM</span>(uv_sku_rank) <span class="keyword">AS</span> uv_sku_rank, <span class="comment">--流量uv排序-三级类目下所有sku</span></span><br><span class="line">	<span class="keyword">SUM</span>(uv_sku_brand_rnak) <span class="keyword">AS</span> uv_sku_brand_rnak <span class="comment">--流量uv排序-三级类目下主品牌内sku排序</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			item_third_cate_cd,</span><br><span class="line">			item_sku_id,</span><br><span class="line">			terminal_type,</span><br><span class="line">			trade_type,</span><br><span class="line">			main_brand_id,</span><br><span class="line">			price_band_id,</span><br><span class="line">			row_number() <span class="keyword">over</span>(<span class="keyword">distribute</span> <span class="keyword">BY</span> terminal_type, price_band_id, trade_type, item_third_cate_cd <span class="keyword">sort</span> <span class="keyword">by</span> uv <span class="keyword">DESC</span>, pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> uv_sku_rank,</span><br><span class="line">			<span class="number">0</span> <span class="keyword">AS</span> uv_sku_brand_rnak</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			adm.adm_zh_industry_sku_index_all_ref</span><br><span class="line">		<span class="keyword">WHERE</span></span><br><span class="line">			dt = <span class="string">'2023-03-03'</span></span><br><span class="line">			<span class="keyword">AND</span> stat_ct_cd = <span class="string">'day'</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			item_third_cate_cd,</span><br><span class="line">			item_sku_id,</span><br><span class="line">			terminal_type,</span><br><span class="line">			trade_type,</span><br><span class="line">			main_brand_id,</span><br><span class="line">			price_band_id,</span><br><span class="line">			<span class="number">0</span> <span class="keyword">AS</span> uv_sku_rank,</span><br><span class="line">			row_number() <span class="keyword">over</span>(<span class="keyword">distribute</span> <span class="keyword">BY</span> terminal_type, price_band_id, trade_type, item_third_cate_cd, main_brand_id <span class="keyword">sort</span> <span class="keyword">by</span> uv <span class="keyword">DESC</span>, pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> uv_sku_brand_rnak</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			adm.adm_zh_industry_sku_index_all_ref</span><br><span class="line">		<span class="keyword">WHERE</span></span><br><span class="line">			dt = <span class="string">'2023-03-03'</span></span><br><span class="line">			<span class="keyword">AND</span> stat_ct_cd = <span class="string">'day'</span></span><br><span class="line">	)</span><br><span class="line">	t</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	item_third_cate_cd,</span><br><span class="line">	item_sku_id,</span><br><span class="line">	terminal_type,</span><br><span class="line">	trade_type,</span><br><span class="line">	main_brand_id,</span><br><span class="line">	price_band_id;</span><br></pre></td></tr></table></figure>

<p>执行计划如下，两个window算子分别在stage-1和stage-3中，这两个stage并发执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Explain</span></span><br><span class="line">STAGE DEPENDENCIES:</span><br><span class="line">  Stage<span class="number">-1</span> <span class="keyword">is</span> a root stage</span><br><span class="line">  Stage<span class="number">-2</span> depends <span class="keyword">on</span> stages: Stage<span class="number">-1</span>, Stage<span class="number">-3</span></span><br><span class="line">  Stage<span class="number">-3</span> <span class="keyword">is</span> a root stage</span><br><span class="line">  Stage<span class="number">-0</span> depends <span class="keyword">on</span> stages: Stage<span class="number">-2</span></span><br><span class="line"></span><br><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage<span class="number">-1</span></span><br><span class="line">    <span class="keyword">Map</span> Reduce</span><br><span class="line">      <span class="keyword">Map</span> <span class="keyword">Operator</span> Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="keyword">alias</span>: adm_zh_industry_sku_index_all_ref</span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            Filter <span class="keyword">Operator</span></span><br><span class="line">              predicate: ((dt = <span class="string">'2023-03-03'</span>) <span class="keyword">and</span> (stat_ct_cd = <span class="string">'day'</span>)) (<span class="keyword">type</span>: <span class="built_in">boolean</span>)</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              Reduce <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                <span class="keyword">key</span> expressions: terminal_type (<span class="keyword">type</span>: <span class="built_in">int</span>), price_band_id (<span class="keyword">type</span>: <span class="keyword">string</span>), trade_type (<span class="keyword">type</span>: <span class="keyword">string</span>), item_third_cate_cd (<span class="keyword">type</span>: <span class="keyword">string</span>), uv (<span class="keyword">type</span>: <span class="built_in">bigint</span>), pv (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">                <span class="keyword">sort</span> <span class="keyword">order</span>: ++++<span class="comment">--</span></span><br><span class="line">                <span class="keyword">Map</span>-reduce <span class="keyword">partition</span> <span class="keyword">columns</span>: terminal_type (<span class="keyword">type</span>: <span class="built_in">int</span>), price_band_id (<span class="keyword">type</span>: <span class="keyword">string</span>), trade_type (<span class="keyword">type</span>: <span class="keyword">string</span>), item_third_cate_cd (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                <span class="keyword">value</span> expressions: item_sku_id (<span class="keyword">type</span>: <span class="built_in">bigint</span>), main_brand_id (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">      Reduce <span class="keyword">Operator</span> Tree:</span><br><span class="line">        <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">          expressions: KEY.reducesinkkey3 (<span class="keyword">type</span>: <span class="keyword">string</span>), VALUE._col5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey0 (<span class="keyword">type</span>: <span class="built_in">int</span>), KEY.reducesinkkey2 (<span class="keyword">type</span>: <span class="keyword">string</span>), VALUE._col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey1 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey4 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">          outputColumnNames: _col4, _col6, _col8, _col9, _col12, _col17, _col19, _col20</span><br><span class="line">          <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">          PTF <span class="keyword">Operator</span></span><br><span class="line">            <span class="keyword">Function</span> definitions:</span><br><span class="line">                <span class="keyword">Input</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_0</span><br><span class="line">                  <span class="keyword">output</span> shape: _col4: <span class="keyword">string</span>, _col6: <span class="built_in">bigint</span>, _col8: <span class="built_in">int</span>, _col9: <span class="keyword">string</span>, _col12: <span class="keyword">string</span>, _col17: <span class="keyword">string</span>, _col19: <span class="built_in">bigint</span>, _col20: <span class="built_in">bigint</span></span><br><span class="line">                  <span class="keyword">type</span>: WINDOWING</span><br><span class="line">                Windowing <span class="keyword">table</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_1</span><br><span class="line">                  <span class="keyword">name</span>: windowingtablefunction</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span>: _col20(<span class="keyword">DESC</span>), _col19(<span class="keyword">DESC</span>)</span><br><span class="line">                  <span class="keyword">partition</span> <span class="keyword">by</span>: _col8, _col17, _col9, _col4</span><br><span class="line">                  <span class="keyword">raw</span> <span class="keyword">input</span> shape:</span><br><span class="line">                  <span class="keyword">window</span> functions:</span><br><span class="line">                      <span class="keyword">window</span> <span class="keyword">function</span> definition</span><br><span class="line">                        <span class="keyword">alias</span>: row_number_window_0</span><br><span class="line">                        <span class="keyword">name</span>: row_number</span><br><span class="line">                        <span class="keyword">window</span> <span class="keyword">function</span>: GenericUDAFRowNumberEvaluator</span><br><span class="line">                        <span class="keyword">window</span> frame: <span class="keyword">PRECEDING</span>(<span class="keyword">MAX</span>)~<span class="keyword">FOLLOWING</span>(<span class="keyword">MAX</span>)</span><br><span class="line">                        isPivotResult: <span class="literal">true</span></span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">              expressions: _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col8 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col12 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col17 (<span class="keyword">type</span>: <span class="keyword">string</span>), row_number_window_0 (<span class="keyword">type</span>: <span class="built_in">int</span>), <span class="number">0</span> (<span class="keyword">type</span>: <span class="built_in">int</span>)</span><br><span class="line">              outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">File</span> <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                <span class="keyword">table</span>:</span><br><span class="line">                    <span class="keyword">input</span> <span class="keyword">format</span>: org.apache.hadoop.mapred.SequenceFileInputFormat</span><br><span class="line">                    <span class="keyword">output</span> <span class="keyword">format</span>: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage<span class="number">-2</span></span><br><span class="line">    <span class="keyword">Map</span> Reduce</span><br><span class="line">      <span class="keyword">Map</span> <span class="keyword">Operator</span> Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="keyword">Union</span></span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">35463386</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">15178329326</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">Group</span> <span class="keyword">By</span> <span class="keyword">Operator</span></span><br><span class="line">                aggregations: <span class="keyword">sum</span>(_col6), <span class="keyword">sum</span>(_col7)</span><br><span class="line">                <span class="keyword">keys</span>: _col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                <span class="keyword">mode</span>: <span class="keyword">hash</span></span><br><span class="line">                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7</span><br><span class="line">                <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">35463386</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">15178329326</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                Reduce <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                  <span class="keyword">key</span> expressions: _col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                  <span class="keyword">sort</span> <span class="keyword">order</span>: ++++++</span><br><span class="line">                  <span class="keyword">Map</span>-reduce <span class="keyword">partition</span> <span class="keyword">columns</span>: _col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                  <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">35463386</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">15178329326</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                  <span class="keyword">value</span> expressions: _col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col7 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="keyword">Union</span></span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">35463386</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">15178329326</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">Group</span> <span class="keyword">By</span> <span class="keyword">Operator</span></span><br><span class="line">                aggregations: <span class="keyword">sum</span>(_col6), <span class="keyword">sum</span>(_col7)</span><br><span class="line">                <span class="keyword">keys</span>: _col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                <span class="keyword">mode</span>: <span class="keyword">hash</span></span><br><span class="line">                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7</span><br><span class="line">                <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">35463386</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">15178329326</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                Reduce <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                  <span class="keyword">key</span> expressions: _col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                  <span class="keyword">sort</span> <span class="keyword">order</span>: ++++++</span><br><span class="line">                  <span class="keyword">Map</span>-reduce <span class="keyword">partition</span> <span class="keyword">columns</span>: _col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                  <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">35463386</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">15178329326</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                  <span class="keyword">value</span> expressions: _col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col7 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">      Reduce <span class="keyword">Operator</span> Tree:</span><br><span class="line">        <span class="keyword">Group</span> <span class="keyword">By</span> <span class="keyword">Operator</span></span><br><span class="line">          aggregations: <span class="keyword">sum</span>(VALUE._col0), <span class="keyword">sum</span>(VALUE._col1)</span><br><span class="line">          <span class="keyword">keys</span>: KEY._col0 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY._col1 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY._col2 (<span class="keyword">type</span>: <span class="built_in">int</span>), KEY._col3 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY._col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY._col5 (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">          <span class="keyword">mode</span>: mergepartial</span><br><span class="line">          outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7</span><br><span class="line">          <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">          <span class="keyword">File</span> <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">            compressed: <span class="literal">false</span></span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            <span class="keyword">table</span>:</span><br><span class="line">                <span class="keyword">input</span> <span class="keyword">format</span>: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                <span class="keyword">output</span> <span class="keyword">format</span>: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage<span class="number">-3</span></span><br><span class="line">    <span class="keyword">Map</span> Reduce</span><br><span class="line">      <span class="keyword">Map</span> <span class="keyword">Operator</span> Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="keyword">alias</span>: adm_zh_industry_sku_index_all_ref</span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            Filter <span class="keyword">Operator</span></span><br><span class="line">              predicate: ((dt = <span class="string">'2023-03-03'</span>) <span class="keyword">and</span> (stat_ct_cd = <span class="string">'day'</span>)) (<span class="keyword">type</span>: <span class="built_in">boolean</span>)</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              Reduce <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                <span class="keyword">key</span> expressions: terminal_type (<span class="keyword">type</span>: <span class="built_in">int</span>), price_band_id (<span class="keyword">type</span>: <span class="keyword">string</span>), trade_type (<span class="keyword">type</span>: <span class="keyword">string</span>), item_third_cate_cd (<span class="keyword">type</span>: <span class="keyword">string</span>), main_brand_id (<span class="keyword">type</span>: <span class="keyword">string</span>), uv (<span class="keyword">type</span>: <span class="built_in">bigint</span>), pv (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">                <span class="keyword">sort</span> <span class="keyword">order</span>: +++++<span class="comment">--</span></span><br><span class="line">                <span class="keyword">Map</span>-reduce <span class="keyword">partition</span> <span class="keyword">columns</span>: terminal_type (<span class="keyword">type</span>: <span class="built_in">int</span>), price_band_id (<span class="keyword">type</span>: <span class="keyword">string</span>), trade_type (<span class="keyword">type</span>: <span class="keyword">string</span>), item_third_cate_cd (<span class="keyword">type</span>: <span class="keyword">string</span>), main_brand_id (<span class="keyword">type</span>: <span class="keyword">string</span>)</span><br><span class="line">                <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">                <span class="keyword">value</span> expressions: item_sku_id (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">      Reduce <span class="keyword">Operator</span> Tree:</span><br><span class="line">        <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">          expressions: KEY.reducesinkkey3 (<span class="keyword">type</span>: <span class="keyword">string</span>), VALUE._col5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey0 (<span class="keyword">type</span>: <span class="built_in">int</span>), KEY.reducesinkkey2 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey4 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey1 (<span class="keyword">type</span>: <span class="keyword">string</span>), KEY.reducesinkkey6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), KEY.reducesinkkey5 (<span class="keyword">type</span>: <span class="built_in">bigint</span>)</span><br><span class="line">          outputColumnNames: _col4, _col6, _col8, _col9, _col12, _col17, _col19, _col20</span><br><span class="line">          <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">          PTF <span class="keyword">Operator</span></span><br><span class="line">            <span class="keyword">Function</span> definitions:</span><br><span class="line">                <span class="keyword">Input</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_0</span><br><span class="line">                  <span class="keyword">output</span> shape: _col4: <span class="keyword">string</span>, _col6: <span class="built_in">bigint</span>, _col8: <span class="built_in">int</span>, _col9: <span class="keyword">string</span>, _col12: <span class="keyword">string</span>, _col17: <span class="keyword">string</span>, _col19: <span class="built_in">bigint</span>, _col20: <span class="built_in">bigint</span></span><br><span class="line">                  <span class="keyword">type</span>: WINDOWING</span><br><span class="line">                Windowing <span class="keyword">table</span> definition</span><br><span class="line">                  <span class="keyword">input</span> <span class="keyword">alias</span>: ptf_1</span><br><span class="line">                  <span class="keyword">name</span>: windowingtablefunction</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span>: _col20(<span class="keyword">DESC</span>), _col19(<span class="keyword">DESC</span>)</span><br><span class="line">                  <span class="keyword">partition</span> <span class="keyword">by</span>: _col8, _col17, _col9, _col4, _col12</span><br><span class="line">                  <span class="keyword">raw</span> <span class="keyword">input</span> shape:</span><br><span class="line">                  <span class="keyword">window</span> functions:</span><br><span class="line">                      <span class="keyword">window</span> <span class="keyword">function</span> definition</span><br><span class="line">                        <span class="keyword">alias</span>: row_number_window_0</span><br><span class="line">                        <span class="keyword">name</span>: row_number</span><br><span class="line">                        <span class="keyword">window</span> <span class="keyword">function</span>: GenericUDAFRowNumberEvaluator</span><br><span class="line">                        <span class="keyword">window</span> frame: <span class="keyword">PRECEDING</span>(<span class="keyword">MAX</span>)~<span class="keyword">FOLLOWING</span>(<span class="keyword">MAX</span>)</span><br><span class="line">                        isPivotResult: <span class="literal">true</span></span><br><span class="line">            <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">            <span class="keyword">Select</span> <span class="keyword">Operator</span></span><br><span class="line">              expressions: _col4 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col6 (<span class="keyword">type</span>: <span class="built_in">bigint</span>), _col8 (<span class="keyword">type</span>: <span class="built_in">int</span>), _col9 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col12 (<span class="keyword">type</span>: <span class="keyword">string</span>), _col17 (<span class="keyword">type</span>: <span class="keyword">string</span>), <span class="number">0</span> (<span class="keyword">type</span>: <span class="built_in">int</span>), row_number_window_0 (<span class="keyword">type</span>: <span class="built_in">int</span>)</span><br><span class="line">              outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7</span><br><span class="line">              <span class="keyword">Statistics</span>: <span class="keyword">Num</span> <span class="keyword">rows</span>: <span class="number">17731693</span> <span class="keyword">Data</span> <span class="keyword">size</span>: <span class="number">7589164663</span> Basic stats: <span class="keyword">COMPLETE</span> <span class="keyword">Column</span> stats: <span class="keyword">NONE</span></span><br><span class="line">              <span class="keyword">File</span> <span class="keyword">Output</span> <span class="keyword">Operator</span></span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                <span class="keyword">table</span>:</span><br><span class="line">                    <span class="keyword">input</span> <span class="keyword">format</span>: org.apache.hadoop.mapred.SequenceFileInputFormat</span><br><span class="line">                    <span class="keyword">output</span> <span class="keyword">format</span>: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage<span class="number">-0</span></span><br><span class="line">    <span class="keyword">Fetch</span> <span class="keyword">Operator</span></span><br><span class="line">      <span class="keyword">limit</span>: <span class="number">-1</span></span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure>



<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="https://zhuanlan.zhihu.com/p/450298503" target="_blank" rel="noopener">SQL函数-窗口函数</a></p>
<p><a href="https://blog.csdn.net/lianghecai52171314/article/details/104658201" target="_blank" rel="noopener">order by、distribute by、sort by、group by、partition by的区别</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/HiveSQL/" rel="tag"><i class="fa fa-tag"></i> HiveSQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/27/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E6%97%A5%E6%9C%9F%E8%BD%AC%E6%8D%A2/" rel="next" title="HiveSQL实战积累_日期转换">
                <i class="fa fa-chevron-left"></i> HiveSQL实战积累_日期转换
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/11/11/ClickHouse_ClickHouse%E5%B8%B8%E8%A7%81%E7%B3%BB%E7%BB%9F%E8%A1%A8%E4%B8%8E%E7%A3%81%E7%9B%98%E8%87%AA%E5%8A%A8%E8%BF%81%E7%A7%BB%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="prev" title="ClickHouse_ClickHouse常见系统表与磁盘自动迁移问题排查">
                ClickHouse_ClickHouse常见系统表与磁盘自动迁移问题排查 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.jpg"
                alt="zju岩手县小森" />
            
              <p class="site-author-name" itemprop="name">zju岩手县小森</p>
              <p class="site-description motion-element" itemprop="description">看的远固然重要 但是走好眼前的路才是关键</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">157</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">139</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.instagram.com/littleforestjia" target="_blank" title="Instagram">
                      Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://space.bilibili.com/29623500" target="_blank" title="Bilibili">
                      Bilibili</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#HiveSQL实战积累-窗口函数"><span class="nav-number">1.</span> <span class="nav-text">HiveSQL实战积累_窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-窗口函数基本概念"><span class="nav-number">1.1.</span> <span class="nav-text">1.窗口函数基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-窗口函数概述"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 窗口函数概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-Frame窗口区间原理"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 Frame窗口区间原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-窗口函数分类"><span class="nav-number">1.2.</span> <span class="nav-text">2.窗口函数分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-聚合函数"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 聚合函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-排序函数"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 排序函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-偏移分析函数"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 偏移分析函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-partitionBy-amp-distributeBy区别"><span class="nav-number">1.3.</span> <span class="nav-text">3.partitionBy&amp;distributeBy区别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-order-by全局排序"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 order by全局排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-sort-by局部排序"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 sort by局部排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-distribute-by分区"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 distribute by分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-group-by"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 group by</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-cluster-by"><span class="nav-number">1.3.5.</span> <span class="nav-text">3.5 cluster by</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-distribute-by与partition-by的区别"><span class="nav-number">1.3.6.</span> <span class="nav-text">3.6 distribute by与partition by的区别</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-分时累积预计算实战"><span class="nav-number">1.4.</span> <span class="nav-text">4.分时累积预计算实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-数据加工路径"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 数据加工路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-指标分时统计再窗口函数累加"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 指标分时统计再窗口函数累加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-join时间维表补全断点"><span class="nav-number">1.4.3.</span> <span class="nav-text">4.3 join时间维表补全断点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-串行窗口函数优化实战"><span class="nav-number">1.5.</span> <span class="nav-text">5.串行窗口函数优化实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-单个select中多个窗口函数执行顺序"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 单个select中多个窗口函数执行顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-串行窗口函数优化实例"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 串行窗口函数优化实例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文献"><span class="nav-number">1.6.</span> <span class="nav-text">参考文献</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zju岩手县小森</span>

  
</div>















        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
