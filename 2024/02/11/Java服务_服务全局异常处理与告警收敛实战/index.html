<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Exception," />










<meta name="description" content="Java服务_服务全局异常处理与告警收敛实战一、Java异常相关概念1.异常类Throwable类 Java中所有异常类的父类，它包含了最终要的两个类Exception和Error。 Error类 属于程序无法处理的错误，是JVM需要承担的，无法通过try-catch进行捕捉，例如系统崩溃、内存不足、堆栈溢出，编译器不会对这类异常进行检查，一旦发生就容易导致程序运行终止，仅靠程序本身无法恢复。 E">
<meta property="og:type" content="article">
<meta property="og:title" content="Java服务_服务全局异常处理与告警收敛实战">
<meta property="og:url" content="http://https//littleforestjia.github.io/2024/02/11/Java%E6%9C%8D%E5%8A%A1_%E6%9C%8D%E5%8A%A1%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%8E%E5%91%8A%E8%AD%A6%E6%94%B6%E6%95%9B%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="岩手县小森的博客">
<meta property="og:description" content="Java服务_服务全局异常处理与告警收敛实战一、Java异常相关概念1.异常类Throwable类 Java中所有异常类的父类，它包含了最终要的两个类Exception和Error。 Error类 属于程序无法处理的错误，是JVM需要承担的，无法通过try-catch进行捕捉，例如系统崩溃、内存不足、堆栈溢出，编译器不会对这类异常进行检查，一旦发生就容易导致程序运行终止，仅靠程序本身无法恢复。 E">
<meta property="article:published_time" content="2024-02-10T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-25T09:23:00.420Z">
<meta property="article:author" content="zju岩手县小森">
<meta property="article:tag" content="Exception">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://https://littleforestjia.github.io/2024/02/11/Java服务_服务全局异常处理与告警收敛实战/"/>





  <title>Java服务_服务全局异常处理与告警收敛实战 | 岩手县小森的博客</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">岩手县小森的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力将眼前的每一天过得精彩</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://https://littleforestjia.github.io/2024/02/11/Java%E6%9C%8D%E5%8A%A1_%E6%9C%8D%E5%8A%A1%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%8E%E5%91%8A%E8%AD%A6%E6%94%B6%E6%95%9B%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zju岩手县小森">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岩手县小森的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java服务_服务全局异常处理与告警收敛实战</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-11T00:00:00+08:00">
                2024-02-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index">
                    <span itemprop="name">Java服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Java服务-服务全局异常处理与告警收敛实战"><a href="#Java服务-服务全局异常处理与告警收敛实战" class="headerlink" title="Java服务_服务全局异常处理与告警收敛实战"></a>Java服务_服务全局异常处理与告警收敛实战</h1><h2 id="一、Java异常相关概念"><a href="#一、Java异常相关概念" class="headerlink" title="一、Java异常相关概念"></a>一、Java异常相关概念</h2><h3 id="1-异常类"><a href="#1-异常类" class="headerlink" title="1.异常类"></a>1.异常类</h3><p><strong>Throwable类</strong></p>
<p>Java中所有异常类的父类，它包含了最终要的两个类Exception和Error。</p>
<p><strong>Error类</strong></p>
<p>属于程序无法处理的错误，是JVM需要承担的，无法通过try-catch进行捕捉，例如系统崩溃、内存不足、堆栈溢出，编译器不会对这类异常进行检查，一旦发生就容易导致程序运行终止，仅靠程序本身无法恢复。</p>
<p><strong>Exception类</strong></p>
<p>程序本身可以处理的异常，可以通过catch进行捕捉，也是我们需要处理的，以保证程序能够正常运行。Exception又分为运行时异常（RunTimeException，又叫非受检查异常unchecked Exception）和非运行时异常（又叫受检查异常checked Exception）。</p>
<p>运行时异常我们可处理可不处理，<strong>一般是程序运行时程序逻辑错误引起</strong>，我们应该在编码时尽量避免这种错误，比如：NullPointException。</p>
<p>非运行时异常是Exception中除RunTimeException以外的异常，<strong>一般是代码编译时出错引起</strong>，比如：IOException、SQLException等这种异常，Java编译器会强制要求我们处理。</p>
<h3 id="2-异常的处理方式"><a href="#2-异常的处理方式" class="headerlink" title="2.异常的处理方式"></a>2.异常的处理方式</h3><p><strong>try-catch</strong></p>
<p>try中放可能发生异常的代码，如果发生异常，后面的代码不会再执行，直接进入catch，在catch中拿到异常对象，我们进行处理。</p>
<p><strong>try-catch-finally</strong></p>
<p>finally是无论异常是否发生都会执行的，通常用来释放资源。</p>
<p><strong>try-finally</strong></p>
<p>相当于没有捕捉异常。</p>
<p><strong>throws</strong></p>
<p>在方法名后面进行抛出，表明该方法对此异常不进行处理，由调用者进行处理，谁用谁处理，调用者也可继续向上抛出。</p>
<p><strong>throw</strong></p>
<p>在方法内进行抛出，我们手动抛出一个异常对象。</p>
<h3 id="3-注意事项"><a href="#3-注意事项" class="headerlink" title="3.注意事项"></a>3.注意事项</h3><p><strong>对于非运行时异常，程序必须进行处理，用try-catch或throws都可以，在写代码时idea会提示。</strong>一般会提示我们在方法后面加上throws。</p>
<p><strong>对运行时异常，如果程序中没有显式使用上一节中异常处理方法处理，则默认使用处理方法时throws处理。</strong></p>
<p>子类重写父类的方法时，对抛出异常的规定：子类重写的方法，所抛出的异常类型不能大于父类异常的类型，可以是一样的类型或者是父类异常的子类。</p>
<h3 id="4-自定义异常"><a href="#4-自定义异常" class="headerlink" title="4.自定义异常"></a>4.自定义异常</h3><p>自定义异常类继承Exception或RunTimeException；</p>
<p>继承Exception属于非运行时异常；</p>
<p>继承RunTimeException属于运行时异常。</p>
<h2 id="二、csdn博客配置全局异常处理实战"><a href="#二、csdn博客配置全局异常处理实战" class="headerlink" title="二、csdn博客配置全局异常处理实战"></a>二、csdn博客配置全局异常处理实战</h2><p>在项目中我们通常会写很多接口，各种各样的异常出现会让我们的返回结果很受影响，因为我们的接口都会写通用的返回格式，但是异常出现时返回的错误就和我们的返回格式产生分歧，所以为了保证这种情况不出现，我们就需要配置全局异常处理，在异常发生时也按照我们想要的返回格式。</p>
<p><strong>核心：@RestControllerAdvice+@ExceptionHandler</strong></p>
<h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h3><p>常见的操作码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 枚举了一些常用API操作码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ResultCode implements IErrorCode &#123;</span><br><span class="line">    SUCCESS(<span class="number">200</span>, <span class="string">"操作成功"</span>),</span><br><span class="line">    FAILED(<span class="number">400</span>, <span class="string">"操作失败"</span>),</span><br><span class="line">    VALIDATE_FAILED(<span class="number">404</span>, <span class="string">"参数检验失败"</span>),</span><br><span class="line">    UNAUTHORIZED(<span class="number">401</span>, <span class="string">"暂未登录或token已经过期"</span>),</span><br><span class="line">    FORBIDDEN(<span class="number">403</span>, <span class="string">"没有相关权限"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ResultCode</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>封装API的错误码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装API的错误码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IErrorCode</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getMessage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通用的返回体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lcp.fitness.common.api.IErrorCode;</span><br><span class="line"><span class="keyword">import</span> com.lcp.fitness.common.api.ResultCode;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResponse</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommonResponse</span><span class="params">(<span class="keyword">int</span> code, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommonResponse</span><span class="params">(<span class="keyword">int</span> code, String msg, T data, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">fail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(ResultCode.FAILED.getCode(), ResultCode.FAILED.getMessage(), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">fail</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(ResultCode.FAILED.getCode(), msg, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">fail</span><span class="params">(IErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(errorCode.getCode(), errorCode.getMessage(), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">fail</span><span class="params">(IErrorCode errorCode, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(errorCode.getCode(), msg, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">fail</span><span class="params">(<span class="keyword">int</span> code, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(code, msg, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(ResultCode.SUCCESS.getCode(), ResultCode.SUCCESS.getMessage(), <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">success</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(ResultCode.SUCCESS.getCode(), ResultCode.SUCCESS.getMessage(), data, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功返回结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse <span class="title">success</span><span class="params">(String msg, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse(ResultCode.SUCCESS.getCode(), msg, data, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数验证失败返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse&lt;T&gt; <span class="title">validateFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fail(ResultCode.VALIDATE_FAILED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数验证失败返回结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse&lt;T&gt; <span class="title">validateFailed</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse&lt;T&gt;(ResultCode.VALIDATE_FAILED.getCode(), message, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 未登录返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse&lt;T&gt; <span class="title">unauthorized</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse&lt;T&gt;(ResultCode.UNAUTHORIZED.getCode(), ResultCode.UNAUTHORIZED.getMessage(), data, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 未授权返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">CommonResponse&lt;T&gt; <span class="title">forbidden</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse&lt;T&gt;(ResultCode.FORBIDDEN.getCode(), ResultCode.FORBIDDEN.getMessage(), data, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-全局异常处理实现"><a href="#2-全局异常处理实现" class="headerlink" title="2.全局异常处理实现"></a>2.全局异常处理实现</h3><p>自定义我们的异常类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lcp.fitness.common.api.IErrorCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义API异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IErrorCode errorCode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiException</span><span class="params">(IErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(errorCode.getMessage());</span><br><span class="line">        <span class="keyword">this</span>.errorCode = errorCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiException</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IErrorCode <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全局异常处理：</p>
<p>这里可以使用@RestControllerAdvice+@ExceptionHandler或者@ControllerAdvice+@ExceptionHandler+@ResponseBody，都是可以的，@RestControllerAdvice=@ControllerAdvice+@ResponseBody。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lcp.fitness.utils.CommonResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = ApiException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">CommonResponse</span> <span class="title">handle</span>(<span class="title">ApiException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> CommonResponse.fail(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">CommonResponse</span> <span class="title">exception</span>(<span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> CommonResponse.fail(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * springsecurity权限认证失败返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = AccessDeniedException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">CommonResponse</span> <span class="title">accessDeniedException</span>(<span class="title">AccessDeniedException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> CommonResponse.fail(<span class="string">"用户无权限访问"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这样在我们某个接口再有运行时异常时，就不会有奇奇怪怪的格式了，我们希望即使有错误也都是我们定义好的这种格式。但是记住，要想统一异常最重要的还是对于异常出现位置的主观判断，我们要判断出哪些地方可能出现哪些代码异常或业务逻辑异常，然后在对应位置进行异常的抓取和异常码填充。</strong></p>
<h3 id="3-特殊情况filter中的异常如何捕捉"><a href="#3-特殊情况filter中的异常如何捕捉" class="headerlink" title="3.特殊情况filter中的异常如何捕捉"></a>3.特殊情况filter中的异常如何捕捉</h3><p>从我们全局异常的注解名字@RestControllerAdvice我们也可以看出，他是针对controller层做了切面处理，也就是说如果异常最终出现在了controller层中，我们可以进行处理，但是如果请求根本就没有到达controller层，在前面的filter层就出现了异常并返回，那么就无法捕捉到。<strong>过滤器Filter可以在controller处理逻辑之前和之后加入一些其他逻辑，可以在controller之前进行验证和信息处理，或者在controller之后进行统计记录。</strong></p>
<p>fliter案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lcp.fitness.common.component.RedisCache;</span><br><span class="line"><span class="keyword">import</span> com.lcp.fitness.dto.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.lcp.fitness.utils.JwtTokenUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取token</span></span><br><span class="line">        String token = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(token)) &#123;</span><br><span class="line">            <span class="comment">//放行</span></span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//解析token</span></span><br><span class="line">        String userId = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Claims claims = JwtTokenUtil.parseJWT(token);</span><br><span class="line">            userId = claims.getSubject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"token无效"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从redis中获取用户信息</span></span><br><span class="line">        String redisKey = <span class="string">"login:"</span> + userId;</span><br><span class="line">        LoginUser loginUser = redisCache.getCacheObject(redisKey);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(loginUser))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"用户未登录"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存入SecurityContextHolder</span></span><br><span class="line">        <span class="comment">//TODO 获取权限信息封装到Authentication中</span></span><br><span class="line">        UsernamePasswordAuthenticationToken authenticationToken =</span><br><span class="line">                <span class="keyword">new</span> UsernamePasswordAuthenticationToken(loginUser,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解决filter中不起作用，我们没有办法改变@RestControllerAdvice注解的作用域，我的解决思路是将filter中的异常扔到controller层中，为此需要定义一个controller，专门用来接收这些特殊情况的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.lcp.fitness.common.exception.ApiException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理-filter中的异常处理（全局异常只能处理controller层的异常，而filter中的异常捕捉不到，</span></span><br><span class="line"><span class="comment"> * 所以需要将filter中的异常全部重定向到该controller中，以实现全局异常的统一处理格式）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/exception"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/handler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exception</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String msg = (String) request.getAttribute(<span class="string">"msg"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在filter中，将原来throw抛出异常的代码改成下面的代码，使用重定向将异常信息转到controller层中，再加上一个return结束filter中的代码，不再执行后续逻辑。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.setAttribute(&quot;msg&quot;, &quot;token无效&quot;);</span><br><span class="line">request.getRequestDispatcher(&quot;&#x2F;exception&#x2F;handler&quot;).forward(request, response);</span><br><span class="line">return;</span><br></pre></td></tr></table></figure>



<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="https://blog.csdn.net/weixin_44009147/article/details/129422992" target="_blank" rel="noopener">Java中如何统一处理异常</a></p>
<h2 id="三、定义驱动全局异常处理与告警收敛实战"><a href="#三、定义驱动全局异常处理与告警收敛实战" class="headerlink" title="三、定义驱动全局异常处理与告警收敛实战"></a>三、定义驱动全局异常处理与告警收敛实战</h2><h3 id="1-准备工作-1"><a href="#1-准备工作-1" class="headerlink" title="1.准备工作"></a>1.准备工作</h3><p>常见的告警/异常编码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> UmpUserAlarmType &#123;</span><br><span class="line"></span><br><span class="line">    FILTER_EXCEPTION(<span class="string">"维度筛选值为空"</span>, <span class="string">"请检查传参中筛选值是否为空。"</span>),</span><br><span class="line"></span><br><span class="line">    REQUEST_TIME_START_MORE_END_EXCEPTION(<span class="string">"查询时间范围错误：开始时间 %s 大于结束时间 %s "</span>, <span class="string">"请检查dt传参。"</span>),</span><br><span class="line"></span><br><span class="line">    REQUEST_TIME_TOO_LARGE_EXCEPTION(<span class="string">"查询的时间范围错误：时间跨度太大。最大查询时间范围为 %s 天，实际查询时间范围为 %s 天"</span>, <span class="string">"请检查dt传参。"</span>),</span><br><span class="line"></span><br><span class="line">    REQUEST_TIME_EMPTY_EXCEPTION(<span class="string">"查询时间为空"</span>, <span class="string">"请检查dt传参。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_TIMEOUT(<span class="string">"EZD调用超时"</span>, <span class="string">"请根据UUID查看详细SQL并优化相关查询SQL。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_TABLE_NOT_EXIST(<span class="string">"表 %s 不存在"</span>, <span class="string">"请检查创建表是否成功。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_COLUMN_NOT_EXIST(<span class="string">"列 %s 不存在"</span>, <span class="string">"请检查表相关表的列是否存在。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_MEMORY_LIMIT(<span class="string">"SQL执行超出CK集群内存限制"</span>, <span class="string">"请根据UUID查看详细SQL，并优化相关SQL或联系CK集群负责人调整阈值。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_SQL_EXCEPTION(<span class="string">"SQL执行异常"</span>, <span class="string">"请根据UUID查看详细SQL并确认异常。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_DB_EXCEPTION(<span class="string">"DB异常"</span>, <span class="string">"请根据UUID查看详细SQL并确认异常。"</span>),</span><br><span class="line"></span><br><span class="line">    EZD_IMPLEMENT_TIMEOUT(<span class="string">"SQL执行时间超过CK集群限制时间 %s s"</span>, <span class="string">"请根据UUID查看详细SQL并优化相关查询SQL或者调整CK阈值。"</span>),</span><br><span class="line"></span><br><span class="line">    ROUTE_DIMENSION_EXCEPTION(<span class="string">"配置中缺少维度【%s】"</span>, <span class="string">"请在逻辑表新增相关维度."</span>),</span><br><span class="line"></span><br><span class="line">    ROUTE_DIMENSION_COMBINE_EXCEPTION(<span class="string">"预计算不支持相关聚合维度组合【%s】"</span>, <span class="string">"请检查【聚合维度】中是否存在."</span>),</span><br><span class="line"></span><br><span class="line">    ROUTE_METRIC_EXCEPTION(<span class="string">"不支持相关指标查询"</span>, <span class="string">"请检查逻辑表配置。"</span>),</span><br><span class="line"></span><br><span class="line">    ROUTE_LAST_DAY_EXCEPTION(<span class="string">"不支持动态函数lastday能力"</span>, <span class="string">"如需该能力，请补充逻辑表 【%s】 高级配置相关内容！"</span>),</span><br><span class="line"></span><br><span class="line">    ROUTE_EXCEPTION(<span class="string">"路由不支持"</span>, <span class="string">"请联系定义驱动研发同事。"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * errorMsg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String errorMsg;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指导信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String info;</span><br><span class="line"></span><br><span class="line">    UmpUserAlarmType(String errorMsg, String info) &#123;</span><br><span class="line">        <span class="keyword">this</span>.errorMsg = errorMsg;</span><br><span class="line">        <span class="keyword">this</span>.info = info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">geErrorMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通用的http返回体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2621934688487804918L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * header</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Header header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * body</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T body;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * default</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * default</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpResponse</span><span class="params">(Header header, T body)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.header = header;</span><br><span class="line">        <span class="keyword">this</span>.body = body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功返回</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">HttpResponse&lt;T&gt; <span class="title">success</span><span class="params">(T body)</span> </span>&#123;</span><br><span class="line">        Header header = <span class="keyword">new</span> Header();</span><br><span class="line">        header.setCode(String.valueOf(ResponseCode.SUCCESS.getCode()));</span><br><span class="line">        header.setDesc(ResponseCode.SUCCESS.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpResponse&lt;&gt;(header, body);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败返回</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">HttpResponse&lt;T&gt; <span class="title">fail</span><span class="params">(ResponseCode err)</span> </span>&#123;</span><br><span class="line">        Header header = <span class="keyword">new</span> Header();</span><br><span class="line">        header.setCode(String.valueOf(err.getCode()));</span><br><span class="line">        header.setDesc(err.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpResponse&lt;&gt;(header, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败返回</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">HttpResponse&lt;T&gt; <span class="title">fail</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">        Header header = <span class="keyword">new</span> Header();</span><br><span class="line">        header.setCode(String.valueOf(code));</span><br><span class="line">        header.setDesc(message);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpResponse&lt;&gt;(header, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败返回</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">HttpResponse&lt;T&gt; <span class="title">fail</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fail(-<span class="number">1</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-全局异常处理实现-1"><a href="#2-全局异常处理实现-1" class="headerlink" title="2.全局异常处理实现"></a>2.全局异常处理实现</h3><p>自定义异常类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常构造方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommonException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抛异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">throwCommonCommonException</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        log.info(msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CommonException(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抛异常_不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">throwNotFoundException</span><span class="params">(String entity, Long id)</span> </span>&#123;</span><br><span class="line">        String msg = String.format(<span class="string">"%s %s not found"</span>, entity, id);</span><br><span class="line">        throwCommonCommonException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全局异常处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpResponse</span> <span class="title">exceptionHandler</span>(<span class="title">Exception</span> <span class="title">ex</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            log.info(<span class="string">"runtime exception"</span>, ex);</span><br><span class="line">            <span class="keyword">return</span> fail(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> MethodArgumentNotValidException) &#123;</span><br><span class="line">            log.info(<span class="string">"validation exception"</span>, ex);</span><br><span class="line">            String msg = substringAfterLast(ex.getMessage(), <span class="string">"default message"</span>);</span><br><span class="line">            <span class="keyword">return</span> fail(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//对import javax.validation.constraints.NotNull校验统一拦截</span></span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BindException) &#123;</span><br><span class="line">            log.info(<span class="string">"validation exception"</span>, ex);</span><br><span class="line">            String msg = substringAfterLast(ex.getMessage(), <span class="string">"default message"</span>);</span><br><span class="line">            <span class="keyword">return</span> fail(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"uncaught exception: "</span>, ex);</span><br><span class="line">        <span class="keyword">return</span> fail(SYSTEM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-判断业务逻辑异常并抓取和告警"><a href="#3-判断业务逻辑异常并抓取和告警" class="headerlink" title="3.判断业务逻辑异常并抓取和告警"></a>3.判断业务逻辑异常并抓取和告警</h3><p><strong>业务逻辑异常抓得准和抓得全非常重要。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据开始结束日期补充查询时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">replenishDateRangeByStartEnd</span><span class="params">(String startDate, String endDate)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; dateList = Lists.newArrayList();</span><br><span class="line">    String queryStartDate = getDateWithoutTime(startDate);</span><br><span class="line">    String queryEndDate = getDateWithoutTime(endDate);</span><br><span class="line">    <span class="keyword">int</span> dateNum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (String date = queryStartDate; date.compareTo(queryEndDate) &lt;= <span class="number">0</span>; date = getDateAgo(date, -<span class="number">1</span>)) &#123;</span><br><span class="line">        dateList.add(date);</span><br><span class="line">        dateNum += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 日期范围多大</span></span><br><span class="line">    <span class="keyword">if</span> (dateNum &gt;= MAX_QUERY_DAYS) &#123;</span><br><span class="line">        log.error(<span class="string">"getMatchedDateList fail query date range larger than &#123;&#125; startDate &#123;&#125; endDate &#123;&#125;"</span>, MAX_QUERY_DAYS, startDate, endDate);</span><br><span class="line">        String errorMsg = String.format(UmpUserAlarmType.REQUEST_TIME_TOO_LARGE_EXCEPTION.geErrorMsg(), MAX_QUERY_DAYS, dateNum);</span><br><span class="line">        UmpUtil.alarmUser(errorMsg, UmpUserAlarmType.REQUEST_TIME_TOO_LARGE_EXCEPTION.getInfo());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CommonException(String.format(DRIVE_GET_DATE_ERROR_DATE_RANGE_TOO_LARGE.getDesc(), MAX_QUERY_DAYS, dateNum));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dateList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="四、异常处理规约制定实战"><a href="#四、异常处理规约制定实战" class="headerlink" title="四、异常处理规约制定实战"></a>四、异常处理规约制定实战</h2><p><strong>背景：定义驱动服务建设初期，开发人员繁多，业务快速迭代，自定义异常类冗杂繁多，规则不一，对应异常信息和告警信息意义不明或者难以理解等现象严重。后续日积月累，对用户透出系统指引信息混乱，对研发异常告警排查造成巨大负担，过多的不分轻重无意义告警也导致研发响应积极性大大降低。在该背景下，对以web/rpc等形式协议透出给用户或下游系统的异常信息，触达给研发的告警信息进行统一梳理、归类和整改，制定详细的归类标准，形成清晰明了的增量规约，显得非常重要。</strong></p>
<h3 id="1-定义驱动服务异常原因分析及归纳"><a href="#1-定义驱动服务异常原因分析及归纳" class="headerlink" title="1.定义驱动服务异常原因分析及归纳"></a>1.定义驱动服务异常原因分析及归纳</h3><p>根据上述问题分析，可将目前出现的异常归类以下内容：</p>
<p>1.代码规范</p>
<p>​    1.1 异常处理未形成有效的规范，研发根据自身习惯使用异常处理</p>
<p>​    1.2 常规参数校验不完善</p>
<p>​        1.2.1 日期校验不完善</p>
<p>​        1.2.2 数组、列表等传参未判空校验（index size相关报警）</p>
<p>2.协议规范</p>
<p>​    2.1 标准协议未校验协议所必要的参数：trend_type能力未合理校验（dt参数不存在），直接空指针</p>
<p>​    2.2 不支持的协议未按照合理的提示输出给用户，而是直接异常：NotNullExpression协议不支持</p>
<p>3.业务流程规范</p>
<p>​    3.1 相关业务校验应该完善</p>
<p>​    3.2 业务的增删改查操作务必要保留日志现场</p>
<p>4.代码bug</p>
<p>​    4.1 retrying报警</p>
<h3 id="2-系统梳理"><a href="#2-系统梳理" class="headerlink" title="2.系统梳理"></a>2.系统梳理</h3><p><strong>现存异常处理类</strong></p>
<p>系统当前存在的异常总共十三种包含ExternalApiException、CommonException、BizHandleException、JsonProcessingException、RuntimeException、Exception、EzdJsfRouterException、MetaPullException、ParamException、UserException、IllegalArgumentException。</p>
<p>存在的风险及问题：</p>
<ol>
<li>异常类数量过多</li>
<li>部分异常含义不明确</li>
<li>部分异常存在重叠内容，本质可以合并</li>
</ol>
<p><strong>解决方案</strong></p>
<p>约定统一规范的异常处理类，研发应当按照统一的规范进行异常处理，以系统功能范围为异常边界：</p>
<ol>
<li>UserException：用户异常相关、即用户可以处理的异常；</li>
<li>InteractionException：交互异常相关、即BE所有的异常处理；</li>
<li>ProductionException：生产异常相关、即生产加速策略相关的所有异常处理；</li>
<li>RouteException：查询异常相关、即数据查询服务相关的所有异常处理；</li>
<li>CommonException：当不知道或无法明确异常范围时使用的公共兜底异常。</li>
</ol>
<p>针对细节性内容可以作为子集再细分为：</p>
<ol>
<li>ExternalApiException：第三方调用异常</li>
<li>ParamException：传参异常</li>
<li>JsonException：Json序列化异常</li>
<li>等等</li>
</ol>
<p>报警、报错根据上述分类同步匹配处理。</p>
<h3 id="3-制定规约"><a href="#3-制定规约" class="headerlink" title="3.制定规约"></a>3.制定规约</h3><p><strong>规约分为报错异常和报警异常：报错面向用户，报警面向研发。所以我们需要考虑用户群体的理解问题。基于此，异常处理信息应该让接收的人看到具体的信息理解并可以解决。报错不等于报警，报警一定是报错。系统预期外的异常为需要报警的报错；部分系统预期内异常为无须报警的报错，如用户入参错误等；部分系统预期内异常为需要报警的报错，如调用下游时间超时等。</strong></p>
<p>针对预期的定义</p>
<ol>
<li>查询：以标准协议内容为预期内，不属于标准协议的为预期外。</li>
<li>BE：以业务流程为预期内，非业务流程为预期外。</li>
</ol>
<h4 id="3-1-用户-报错"><a href="#3-1-用户-报错" class="headerlink" title="3.1 用户-报错"></a>3.1 用户-报错</h4><ol>
<li><p>预期内</p>
</li>
<li><ol>
<li><p>报错应该包含【报错主体】【错误信息】【解决方案】</p>
</li>
<li><ol>
<li>报错主体：比如逻辑表编辑报错，应该包含逻辑表ID；比如修饰，应该包含修饰ID；查询报错应该报错查询的逻辑表信息，没有的给出其他报错主体</li>
<li>解决方案：应该让用户可以看明白，并且可以自助解决问题，而不是直接抛出研发认为的异常信息</li>
</ol>
</li>
</ol>
</li>
<li><p>预期外</p>
</li>
<li><ol>
<li>报错应该包含使用功能，如【编辑逻辑表失败】</li>
<li>报错应该返回统一异常信息：如【系统异常，请联系研发查看】</li>
<li>最终结构应该为，如：编辑逻辑表失败，系统异常，请联系研发查看。</li>
</ol>
</li>
</ol>
<h4 id="3-2-研发-报警"><a href="#3-2-研发-报警" class="headerlink" title="3.2 研发-报警"></a>3.2 研发-报警</h4><ol>
<li><p>预期内：</p>
</li>
<li><ol>
<li><p>报警应该包含【等级（严重与否）】【环境】【功能范围】【机器】【异常信息】【应急预案（可根据分级）】</p>
</li>
<li><ol>
<li>等级（严重与否）：是为了解决时间成本的问题，比如：当值班被紧急事务影响的时候，其他同事注意相关问题，可以根据等级本身来决定是否介入。</li>
<li>功能范围：基于当前未拆分的架构前提下，明确报警需要处理的人员范围</li>
<li>异常信息：应该尽可能的包含异常相关的具体信息</li>
<li>应急预案：针对部分需要切流等特殊场景，应该有匹配的应急预案，因为部分报警的目的是为了做系统切换，而不是代表系统完全不可用</li>
</ol>
</li>
</ol>
</li>
<li><p>预期外</p>
</li>
<li><ol>
<li><p>报警应该使用统一的异常兜底逻辑</p>
</li>
<li><p>应当尽可能包含如下详细信息：异常的功能点、异常类、以及异常本身。</p>
</li>
<li><ol>
<li>异常的功能点：为了尽快明确相关研发，降低排查时间</li>
<li>异常类：快速定位问题点</li>
<li>异常本身：部分异常，比如空指针异常，可以快速排查出结果。</li>
</ol>
</li>
</ol>
</li>
<li><p>可用率报警</p>
</li>
<li><ol>
<li><p>服务可用率【重要】</p>
</li>
<li><ol>
<li><p>可用率口径统一【重要】，不能让错误内容干扰可用率正常展现</p>
</li>
<li><p>可用率范围</p>
</li>
<li><ol>
<li>查询服务可用率——IntelligentProduceService接口可用率（后续架构拆分，可按照拆分后细化可用率）</li>
<li>生产侧服务可用率——加速策略</li>
<li>配置侧服务可用率——逻辑表编辑、数据源创建等</li>
</ol>
</li>
</ol>
</li>
<li><p>容器可用率：JDOS、负载均衡、磁盘等等</p>
</li>
</ol>
</li>
<li><p>补充：异常可以分为：记录类异常、非记录类异常。</p>
</li>
<li><ol>
<li>记录类异常要有详细信息。</li>
<li>非记录类异常要有通知机制，即【报警机制】。</li>
</ol>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Exception/" rel="tag"><i class="fa fa-tag"></i> Exception</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/02/10/HiveSQL%E5%AE%9E%E6%88%98%E7%A7%AF%E7%B4%AF_%E5%88%86%E6%97%B6%E7%B4%AF%E8%AE%A1%E8%B6%8B%E5%8A%BF%E5%9B%BE%E7%9A%84%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E6%AF%94%E8%BE%83/" rel="next" title="HiveSQL实战积累_分时累计趋势图的多种实现方案与比较">
                <i class="fa fa-chevron-left"></i> HiveSQL实战积累_分时累计趋势图的多种实现方案与比较
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/02/12/Java%E6%9C%8D%E5%8A%A1_%E6%9C%8D%E5%8A%A1%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%92%8C%E6%A0%87%E5%87%86%E5%8C%96%E5%BB%BA%E8%AE%BE%E5%85%AD%E4%BB%B6%E5%A5%97_%E7%BC%93%E5%AD%98&%E7%9B%91%E6%8E%A7&%E9%99%90%E6%B5%81&%E6%97%A5%E5%BF%97&%E5%BC%82%E5%B8%B8&%E5%93%8D%E5%BA%94%E4%BD%93/" rel="prev" title="Java服务_服务稳定性和标准化建设六件套_缓存&监控&限流&日志&异常&响应体">
                Java服务_服务稳定性和标准化建设六件套_缓存&监控&限流&日志&异常&响应体 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.jpg"
                alt="zju岩手县小森" />
            
              <p class="site-author-name" itemprop="name">zju岩手县小森</p>
              <p class="site-description motion-element" itemprop="description">看的远固然重要 但是走好眼前的路才是关键</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">157</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">139</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.instagram.com/littleforestjia" target="_blank" title="Instagram">
                      Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://space.bilibili.com/29623500" target="_blank" title="Bilibili">
                      Bilibili</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Java服务-服务全局异常处理与告警收敛实战"><span class="nav-number">1.</span> <span class="nav-text">Java服务_服务全局异常处理与告警收敛实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Java异常相关概念"><span class="nav-number">1.1.</span> <span class="nav-text">一、Java异常相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-异常类"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.异常类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-异常的处理方式"><span class="nav-number">1.1.2.</span> <span class="nav-text">2.异常的处理方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-注意事项"><span class="nav-number">1.1.3.</span> <span class="nav-text">3.注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-自定义异常"><span class="nav-number">1.1.4.</span> <span class="nav-text">4.自定义异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、csdn博客配置全局异常处理实战"><span class="nav-number">1.2.</span> <span class="nav-text">二、csdn博客配置全局异常处理实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备工作"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-全局异常处理实现"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.全局异常处理实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-特殊情况filter中的异常如何捕捉"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.特殊情况filter中的异常如何捕捉</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文献"><span class="nav-number">1.2.4.</span> <span class="nav-text">参考文献</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、定义驱动全局异常处理与告警收敛实战"><span class="nav-number">1.3.</span> <span class="nav-text">三、定义驱动全局异常处理与告警收敛实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备工作-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-全局异常处理实现-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.全局异常处理实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-判断业务逻辑异常并抓取和告警"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.判断业务逻辑异常并抓取和告警</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、异常处理规约制定实战"><span class="nav-number">1.4.</span> <span class="nav-text">四、异常处理规约制定实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-定义驱动服务异常原因分析及归纳"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.定义驱动服务异常原因分析及归纳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-系统梳理"><span class="nav-number">1.4.2.</span> <span class="nav-text">2.系统梳理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-制定规约"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.制定规约</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-用户-报错"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">3.1 用户-报错</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-研发-报警"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">3.2 研发-报警</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zju岩手县小森</span>

  
</div>















        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
